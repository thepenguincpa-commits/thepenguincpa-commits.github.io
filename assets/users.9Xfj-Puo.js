import{g as B,r as m,Q as V,k as U,M as N,U as n,n as K,o as F,j as s,v as d,u as H,q as J}from"./index.B-zO2jcy.js";import{L as G}from"./LayoutContainer.DB_i7kpz.js";import{U as A,u as M}from"./usersApi.BNtDjJ_q.js";import{I as X}from"./InfiniteQueryWithState.BB8vim5Z.js";import{T as Y}from"./Toggler.CKVCiuUU.js";import{I as y,r as v,e as Z,m as O,n as R,V as ee,F as te,a as p}from"./validators.CuBSd0d9.js";import{S as re}from"./SelectControl.BGsAxn8z.js";import{u as se,a as ae,P as ie}from"./useTranslation.B4Aad4mp.js";import{M as ne}from"./index.BJKN9cGs.js";import{I as C}from"./index.CmXbVTZH.js";import{F as W}from"./index.BQ2Co5HI.js";import{B as f}from"./button.BPmN1wK-.js";import{r as g,F as oe,D as I}from"./renderReactiveCell.HbM7Emo9.js";import{u as Q}from"./useTranslation.JeF3lAzJ.js";import{I as D,T as le}from"./AntdIcon.BzrxpPa1.js";import{T as ce}from"./index.CGcGwI_R.js";import{P as ue,R as me}from"./SyncOutlined.BmjTHdYE.js";import{C as de,T as he}from"./EyeOutlined.DZce5g_D.js";import"./row.ClGDsWbn.js";import"./index.CspahUgb.js";import"./index.BcPC7EJu.js";import"./index.BmkQiUau.js";var j={},E;function pe(){if(E)return j;E=1,Object.defineProperty(j,"__esModule",{value:!0});var a={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M699 353h-46.9c-10.2 0-19.9 4.9-25.9 13.3L469 584.3l-71.2-98.8c-6-8.3-15.6-13.3-25.9-13.3H325c-6.5 0-10.3 7.4-6.5 12.7l124.6 172.8a31.8 31.8 0 0051.7 0l210.6-292c3.9-5.3.1-12.7-6.4-12.7z"}},{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}}]},name:"check-circle",theme:"outlined"};return j.default=a,j}var ge=pe();const fe=B(ge);function T(){return T=Object.assign?Object.assign.bind():function(a){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(a[r]=t[r])}return a},T.apply(this,arguments)}const be=(a,e)=>m.createElement(D,T({},a,{ref:e,icon:fe})),ye=m.forwardRef(be);var x={},z;function ve(){if(z)return x;z=1,Object.defineProperty(x,"__esModule",{value:!0});var a={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"}}]},name:"clock-circle",theme:"outlined"};return x.default=a,x}var Ce=ve();const we=B(Ce);function S(){return S=Object.assign?Object.assign.bind():function(a){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(a[r]=t[r])}return a},S.apply(this,arguments)}const je=(a,e)=>m.createElement(D,S({},a,{ref:e,icon:we})),xe=m.forwardRef(je);class Pe extends V{constructor(e){super(e.queryClient,{queryKey:["managers"],queryFn:async()=>M.getUsers({offset:0,limit:1e3,role:"manager"}),transform:(t={items:[],total:0,offset:0,limit:0})=>{const r=e.repositories.get(A);return{items:t.items.map(o=>r.get(o.id).updateFromJson(o)),repository:r}},staleTime:1e3*60*5,refetchOnWindowFocus:!0})}get repository(){return this.data.repository}get items(){return this.data.items}}var Me=Object.defineProperty,ke=(a,e,t)=>e in a?Me(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,P=(a,e,t)=>ke(a,typeof e!="symbol"?e+"":e,t);class q{constructor(e,t){this.appContext=e,this.role=t,P(this,"query"),P(this,"managersQuery"),P(this,"limit",10),P(this,"offset",0),U(this,{},{autoBind:!0});const r=e.repositories.get(A);this.managersQuery=new Pe(e),this.query=new X(e.queryClient,{queryKey:this.getQueryKey(),queryFn:async()=>M.getUsers({offset:0,limit:20,role:t}),getNextPageParam:(o,l)=>{const i=l.reduce((u,c)=>u+c.items.length,0);if(!(i>=o.total))return i},initialPageParam:0,transform:({pages:o}={pageParams:[],pages:[]})=>({data:o.flatMap(i=>i.items.map(u=>({id:u.id,data:r.get(u.id).updateFromJson(u),manager:u.managerId?this.managersQuery.repository.get(u.managerId):void 0,mutation:this.getUpdateMutation(u.id)}))),total:(o[o.length-1]||{total:0}).total}),onError:o=>{e.notify.toastError(o)},placeholderData:o=>o})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}refresh(){this.query.refetch()}getQueryKey(){return["admin-users",this.role,this.limit,this.offset]}handlePagination(e,t){this.limit=t,this.offset=(e-1)*t,this.query.updateOptions({queryKey:this.getQueryKey()})}getUpdateMutation(e){return new N(this.appContext.queryClient,{mutationFn:async t=>M.patchUsersUserid({userId:e,userAdminUpdate:t}),onSuccess:t=>{this.appContext.repositories.get(A).get(t.id).updateFromJson(t),this.query.invalidate()}})}}var Fe=Object.defineProperty,_e=(a,e,t)=>e in a?Fe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,h=(a,e,t)=>_e(a,typeof e!="symbol"?e+"":e,t);class Le{constructor(e,t){this.appConfig=e,h(this,"mutation"),h(this,"modalToggler",new Y(!1)),h(this,"name",new y("",{validators:[v(()=>this.t.forms("required"))]})),h(this,"role",new re(()=>n.Manager,{options:()=>[{value:n.Manager,label:this.t.common("roles.manager")},{value:n.Admin,label:this.t.common("roles.admin")},{value:n.Advertiser,label:this.t.common("roles.advertiser")},{value:n.Webmaster,label:this.t.common("roles.webmaster")}],validators:[v(()=>this.t.forms("required"))]})),h(this,"email",new y("",{validators:[v(()=>this.t.forms("required")),Z(()=>this.t.forms("invalidEmail"))]})),h(this,"telegram",new y("@",{validators:[O(6,()=>this.t.forms("invalidTelegram"))],onChangeValue:r=>{r.startsWith("@")||this.telegram.setValue(`@${r}`)}})),h(this,"password",new y("",{validators:[v(()=>this.t.forms("required")),R(),O(6,()=>this.t.forms("minLength",{count:6}))]})),h(this,"repassword",new y("",{validators:[v(()=>this.t.forms("required")),R(),O(6,()=>this.t.forms("minLength",{count:6})),r=>this.password.value!==r.value?[{message:this.t.forms("passwordsDoNotMatch"),type:ee.Error}]:[]]})),h(this,"group",new te({name:this.name,role:this.role,email:this.email,telegram:this.telegram,password:this.password,repassword:this.repassword})),U(this,{handleSubmit:K.bound},{autoBind:!0}),this.mutation=new N(e.queryClient,{mutationFn:async r=>M.postUsers({userAdminCreate:r}),onSuccess:r=>{this.modalToggler.disable(),t(r)},onError:r=>{this.appConfig.notify.toastError(r)}})}get t(){return this.appConfig.locale.translations}handleAfterOpenChange(e){e||this.group.reset()}handleSubmit(){if(this.group.isInvalid){this.group.setTouched(!0),this.group.setDirty(!0),this.group.firstErrorControl?.element?.focus();return}const{repassword:e,...t}=this.group.value;this.mutation.mutate(t)}}var Oe=Object.defineProperty,qe=(a,e,t)=>e in a?Oe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,w=(a,e,t)=>qe(a,typeof e!="symbol"?e+"":e,t);class Ae{constructor(e){w(this,"webmastersList"),w(this,"managersList"),w(this,"advertisersList"),w(this,"createModal"),w(this,"tab",n.Webmaster),U(this,{},{autoBind:!0}),this.webmastersList=new q(e,"webmaster"),this.managersList=new q(e,"manager"),this.advertisersList=new q(e,"advertiser"),this.createModal=new Le(e,()=>{this.webmastersList.query.invalidate(),this.advertisersList.query.invalidate(),this.managersList.query.invalidate()})}setTab(e){this.tab=e}get usersList(){return this.tab===n.Advertiser?this.advertisersList:this.tab===n.Manager?this.managersList:this.webmastersList}handleAddUser(){this.createModal.modalToggler.enable()}dispose(){console.log("dispose")}init(){console.log("init")}}const Te="_card_1k3hr_1",Se="_body_1k3hr_1",Ue="_table_1k3hr_4",Re="_pagination_1k3hr_13",k={card:Te,body:Se,table:Ue,pagination:Re},Ie=F(function({model:e}){const{t}=se("users");return s.jsx(ne,{title:t("userForm.createTitle"),destroyOnHidden:!0,open:e.modalToggler.isEnabled,onCancel:e.modalToggler.disable,maskClosable:!1,afterOpenChange:e.handleAfterOpenChange,footer:s.jsxs(W,{gap:"small",justify:"flex-end",children:[s.jsx(f,{onClick:e.modalToggler.disable,children:t("buttons.cancel",{ns:"common"})}),s.jsx(f,{type:"primary",loading:e.mutation.isPending,onClick:e.handleSubmit,disabled:!e.group.isChanged,children:t("buttons.submit",{ns:"common"})})]}),centered:!0,children:s.jsxs(p,{layout:"vertical",onFinish:e.handleSubmit,children:[s.jsx(p.Item,{label:t("userForm.nameLabel"),...e.name.itemProps,children:s.jsx(C,{autoComplete:"name",placeholder:t("userForm.namePlaceholder"),...e.name.inputProps})}),s.jsx(p.Item,{label:t("userForm.roleLabel"),...e.role.itemProps,children:s.jsx(ae,{...e.role.inputProps})}),s.jsx(p.Item,{label:t("userForm.emailLabel"),...e.email.itemProps,children:s.jsx(C,{autoComplete:"email",name:"email",placeholder:t("userForm.emailPlaceholder"),...e.email.inputProps})}),s.jsx(p.Item,{label:t("userForm.telegramLabel"),...e.telegram.itemProps,children:s.jsx(C,{autoComplete:"username",placeholder:t("userForm.emailPlaceholder"),...e.telegram.inputProps})}),s.jsx(p.Item,{label:t("userForm.passwordLabel"),...e.password.itemProps,children:s.jsx(C.Password,{autoComplete:"new-password",placeholder:t("userForm.passwordPlaceholder"),...e.password.inputProps})}),s.jsx(p.Item,{label:t("userForm.confirmPasswordLabel"),...e.repassword.itemProps,children:s.jsx(C.Password,{placeholder:t("userForm.confirmPasswordPlaceholder"),autoComplete:"new-password",...e.repassword.inputProps})})]})})}),$=m.memo(function({name:e,onConfirm:t}){const r=m.useRef(null),o=m.useRef(!1);return s.jsx(ue,{ref:r,title:`${e}?`,onConfirm:l=>(l?.stopPropagation(),t().then(()=>{o.current=!0,r.current?.popupElement.click()}).catch(()=>{o.current=!1})),onPopupClick:l=>{o.current?o.current=!1:l?.stopPropagation()},onCancel:l=>l?.stopPropagation(),placement:"left",children:s.jsx("div",{onClick:l=>l.stopPropagation(),children:e})})}),Ee=F(function({data:e,mutation:t}){const{t:r}=Q("users"),o=m.useMemo(()=>({active:r("actions.activate"),blocked:r("actions.block"),frozen:r("actions.freeze"),pending:r("actions.pending"),review:r("actions.review"),rejected:r("actions.reject")}),[r]),l=m.useMemo(()=>({webmaster:r("actions.webmaster"),advertiser:r("actions.advertiser"),manager:r("actions.manager"),admin:r("actions.admin")}),[r]),i=m.useMemo(()=>{const c=b=>{const L=o[b];return s.jsx($,{onConfirm:()=>t.mutateAsync({status:b}),name:L})};return{items:[{key:d.Active,label:c(d.Active)},{key:d.Review,label:c(d.Review)},{key:d.Rejected,label:c(d.Rejected)},{key:d.Frozen,label:c(d.Frozen)},{key:"divider",type:"divider"},{key:d.Blocked,label:c(d.Blocked),danger:!0}].filter(Boolean)}},[t,o]),u=m.useMemo(()=>{const c=b=>{const L=l[b];return s.jsx($,{onConfirm:()=>t.mutateAsync({role:b}),name:L})};return{items:[e.role!==n.Admin&&{key:n.Admin,label:c(n.Admin)},e.role!==n.Advertiser&&{key:n.Advertiser,label:c(n.Advertiser)},e.role!==n.Manager&&{key:n.Manager,label:c(n.Manager)},e.role!==n.Webmaster&&{key:n.Webmaster,label:c(n.Webmaster)}].filter(Boolean)}},[l,t,e.role]);return s.jsxs(W,{gap:"small",children:[s.jsx(I,{menu:i,trigger:["click"],children:s.jsx(f,{children:r("actions.status")})}),s.jsx(I,{menu:u,trigger:["click"],children:s.jsx(f,{children:r("actions.role")})})]})}),ze=F(function({page:e}){const{t}=Q("users"),r=e.usersList,o=m.useMemo(()=>[{key:"email",title:t("table.email"),render:g(({data:i})=>s.jsxs(le,{title:i.emailConfirmed?t("table.emailConfirmed"):t("table.emailNotConfirmed"),children:[i.email," ",i.emailConfirmed?s.jsx(ye,{style:{color:"var(--ant-color-success)"}}):s.jsx(xe,{style:{color:"var(--ant-color-warning)"}})]}))},{key:"telegram",title:t("table.telegram"),render:g(({data:i})=>i.telegram)},{key:"name",title:t("table.name"),render:g(({data:i})=>i.name)},{key:"status",title:t("table.status"),render:g(({data:i})=>{const u={active:t("status.active"),blocked:t("status.blocked"),frozen:t("status.frozen"),pending:t("status.pending"),review:t("status.review"),rejected:t("status.rejected")},_={active:"success",blocked:"error",frozen:"warning",pending:"processing",review:"processing",rejected:"error"}[i.status]||"default";return s.jsx(ce,{color:_,children:u[i.status]||i.status})})},e.tab!==n.Manager&&{key:"manager",title:t("table.manager"),render:g(({manager:i})=>i?i.name:t("table.managerNone"))},{key:"registeredAt",title:t("table.registeredAt"),render:g(({data:i})=>new Date(i.createdAt).toLocaleDateString()),responsive:["md"]},{key:"actions",title:t("table.actions"),render:g(i=>s.jsx(Ee,{...i})),fixed:"right"}].filter(Boolean),[e.tab,t]);return s.jsxs(s.Fragment,{children:[s.jsx("div",{className:k.table,children:s.jsx(oe,{rowKey:"id",loading:!r.query.isFetched&&{size:"large"},columns:o,pagination:!1,dataSource:r.data})}),s.jsx("div",{className:k.pagination,children:s.jsx(ie,{current:r.currentPage,onChange:r.handlePagination,total:r.total,pageSize:r.limit})})]})}),$e=F(function(){const e=H(),t=J(()=>new Ae(e),[e]);return s.jsxs(G,{children:[s.jsx(Ie,{model:t.createModal}),s.jsx(de,{className:k.card,classNames:{body:k.body},title:s.jsx(he,{tabBarExtraContent:s.jsxs("div",{style:{display:"flex",gap:8},children:[s.jsx(f,{onClick:t.usersList.refresh,loading:t.usersList.query.isFetching,icon:s.jsx(me,{})}),s.jsx(f,{type:"primary",onClick:t.handleAddUser,children:"Добавить пользователя"})]}),items:[{key:n.Webmaster,label:"Вебмастеры"},{key:n.Advertiser,label:"Рекламодатели"},{key:n.Manager,label:"Менеджеры"}],accessKey:t.tab,onChange:t.setTab}),children:s.jsx(ze,{page:t})})]})}),ct=$e;export{ct as component};
