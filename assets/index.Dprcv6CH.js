import{a0 as M,a6 as _,m as R,f as F,aB as I,e as O,t as P,r as m,o as C,j as a,a4 as y,u as E,a1 as D}from"./index.CJpzWARr.js";import{u as h}from"./useTranslation.D1-YSIqG.js";import{B as w}from"./Box.CvVauy6S.js";import"./AppLayout.Dd4AyXhP.js";import{L as N}from"./LayoutContainer.kUniMi3O.js";import{T as q}from"./Toggler.Bo1KxCe6.js";import{C as $}from"./PostbackConfigFormGroup._zR3IWaf.js";import{R as B}from"./Registry.BEmoiC2h.js";import{I as Q}from"./InfiniteQueryWithState.DU3fxF3Q.js";import{O as W}from"./OfferDomainRepository.C35Cl61S.js";import{P as S,a as K}from"./PosbackSettings.D31XM5Ua.js";import{r as d}from"./renderReactiveCell.D7yC0G9H.js";import{D as g}from"./DateFormat.CyIrXEyF.js";import{T as z}from"./index.mfBRClzR.js";import{F as J,D as H}from"./Table.CnZn0sov.js";import{P as G}from"./index.C7EzEdlH.js";import{u as U}from"./useCopyToClipboard.ByVXnvkX.js";import{T as V}from"./AntdIcon.BEv94oZ9.js";import{B as v}from"./button.CTAkPJpI.js";import{R as X}from"./MoreOutlined.CYRW4zmn.js";import{P as Y}from"./index.Dr9pHSB9.js";import{C as Z,T as tt}from"./Input.BJc5rBil.js";import{R as et}from"./SyncOutlined.DPlxgDWy.js";import{D as at}from"./index.DLP9cbOY.js";import"./index.5jmBMbM4.js";import"./validators.puhu6pph.js";import"./row.ZVKcDUTg.js";import"./SelectControl.BdHLXDxG.js";import"./index.CnCisG79.js";import"./ActionButton.D2hXE_0n.js";import"./index.CvuYUNlW.js";import"./useClosable.Emosx8Km.js";import"./index.UwxdIMsP.js";import"./EyeOutlined.C4wc5N2Y.js";import"./index.B7lSVg36.js";import"./index.DfgcMzeU.js";var st=Object.defineProperty,it=(s,t,e)=>t in s?st(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,x=(s,t,e)=>it(s,typeof t!="symbol"?t+"":t,e);class rt{constructor(t,e,i,r={}){this.appContext=t,this.hostnamesQuery=e,this.currentItem=i,this.props=r,x(this,"data"),x(this,"archiveMutation"),x(this,"postbackSettings"),this.data=this.parseData(i),this.postbackSettings=new S(t,this.data.campaign),this.archiveMutation=new M(t.queryClient,{mutationFn:()=>_.deleteCampaignsCampaignid({campaignId:this.campaign.id}),onError:o=>{t.notify.toastError(o)}}),R(this,{data:F.ref,campaign:O})}get id(){return this.campaign.id}get repositories(){return{campaign:this.data.campaignRepository,domains:this.data.domainRepository,hostnames:this.hostnamesQuery.repository}}get hostnames(){return this.hostnamesQuery.items}get campaign(){return this.data.campaign}get archiveState(){return this.archiveMutation}handleArchive(){return this.archiveMutation.mutate()}updateFromJson(t){t!==this.currentItem&&(this.data=this.parseData(t))}parseData(t){const e=this.appContext.repositories.get(I),i=this.appContext.repositories.get(W);return{campaign:e.get(t.id).updateFromJson(t),campaignRepository:e,domainRepository:i}}}var nt=Object.defineProperty,ot=(s,t,e)=>t in s?nt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,f=(s,t,e)=>ot(s,typeof t!="symbol"?t+"":t,e);class j{constructor(t,e){this.isArchive=e,f(this,"query"),f(this,"hostnamesQuery"),f(this,"limit",20),f(this,"offset",0),this.hostnamesQuery=new $(t);const i=new WeakMap;this.query=new Q(t.queryClient,{queryKey:this.getQueryKey(),queryFn:()=>_.getCampaigns({offset:this.offset,limit:this.limit}),getNextPageParam:(r,o)=>{const c=o.reduce((n,l)=>n+l.items.length,0);if(!(c>=r.total))return c},initialPageParam:0,transform:({pages:r}={pageParams:[],pages:[]})=>({data:r.flatMap(c=>{let n=i.get(c);return n||(n=new B(l=>new rt(t,this.hostnamesQuery,l))),n.from(c.items)}),total:(r[r.length-1]||{total:0}).total}),staleTime:1e3*60*5,refetchOnWindowFocus:!0,onError:r=>{t.notify.toastError(r)},placeholderData:r=>r}),P(this,{},{autoBind:!0})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}getQueryKey(){return["admin-offers",this.isArchive,this.limit,this.offset]}refresh(){this.query.refetch()}handlePagination(t,e){this.limit=e,this.offset=(t-1)*e,this.query.updateOptions({queryKey:this.getQueryKey()})}}var ct=Object.defineProperty,lt=(s,t,e)=>t in s?ct(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,p=(s,t,e)=>lt(s,typeof t!="symbol"?t+"":t,e);class mt{constructor(t){p(this,"globalPostback"),p(this,"activeCampaignsList"),p(this,"archiveCampaignsList"),p(this,"tab","active"),p(this,"campaignPostbackToggler",new q(!1)),p(this,"selectedCampaign",null),this.globalPostback=new S(t,null),this.activeCampaignsList=new j(t,!1),this.archiveCampaignsList=new j(t,!0),P(this,{},{autoBind:!0})}setTab(t){this.tab=t}get campaignsList(){return this.tab==="archive"?this.archiveCampaignsList:this.activeCampaignsList}get postbackSettings(){return this.selectedCampaign?this.selectedCampaign.postbackSettings:this.globalPostback}setSelectedCampaign(t){this.selectedCampaign=t}handleOpenCampaignSettings(t){this.selectedCampaign=t,t?.postbackSettings.detailsToggler.enable()}handleAfterOpenChangeCampaignPostback(t){t||this.setSelectedCampaign(null)}dispose(){console.log("dispose")}init(){console.log("init")}}const T=m.createContext(null);function L(){const s=m.useContext(T);if(!s)throw new Error("Необходимо зарегистрировать провайдер WebmasterCampaignsModelContext");return s}var dt=typeof window<"u",pt=function(s,t){return dt?window.matchMedia(s).matches:!1},ut=function(s,t){var e=m.useState(pt(s)),i=e[0],r=e[1];return m.useEffect(function(){var o=!0,c=window.matchMedia(s),n=function(){o&&r(!!c.matches)};return c.addEventListener("change",n),r(c.matches),function(){o=!1,c.removeEventListener("change",n)}},[s]),i};const ht="_secondary_7t0t2_1",gt="_table_7t0t2_4",ft="_pagination_7t0t2_13",bt="_link_7t0t2_19",yt="_name_7t0t2_27",u={secondary:ht,table:gt,pagination:ft,link:bt,name:yt},vt=m.memo(function({name:t,onConfirm:e}){const i=m.useRef(null),r=m.useRef(!1);return a.jsx(Y,{ref:i,title:`${t}?`,onConfirm:o=>(o?.stopPropagation(),e().then(()=>{r.current=!0,i.current?.popupElement.click()}).catch(()=>{r.current=!1})),onPopupClick:o=>{r.current?r.current=!1:o?.stopPropagation()},onCancel:o=>o?.stopPropagation(),placement:"left",children:a.jsx("div",{onClick:o=>o.stopPropagation(),children:t})})}),k=m.memo(function({value:t}){const[e,i]=m.useState(!1),[r,o]=U(),{t:c}=h("common"),n=m.useRef(e);return n.current=e,m.useEffect(()=>{if(r.value&&!n.current){i(!0);const l=setTimeout(()=>{i(!1)},1e3);return()=>{clearTimeout(l)}}},[r]),a.jsx(V,{placement:"left",open:e,overlay:c("actions.copied"),children:a.jsx("div",{className:u.link,onClick:l=>{l.preventDefault(),o(t)},children:a.jsx("a",{href:t,target:"__blank",children:t})})})}),xt=C(function({item:t}){const{t:e}=h("campaign"),i=L(),r=[{key:"stats",label:a.jsx(y,{to:"/statistics",children:e("actions.stats")})},{key:"edit",label:a.jsx(y,{to:"/campaigns/$campaignId",params:{campaignId:t.id},children:e("actions.edit")})},{key:"postback",label:a.jsx("div",{onClick:()=>{i.handleOpenCampaignSettings(t)},children:e("actions.postback")})},{key:"clone",label:a.jsx(y,{to:"/campaigns/$campaignId",params:{campaignId:"new"},search:{from:t.id,offer:t.campaign.offerId},children:e("actions.clone")})},!t.campaign.isArchived&&{key:"divider",type:"divider"},!t.campaign.isArchived&&{key:"archive",label:a.jsx(vt,{onConfirm:t.handleArchive,name:e("actions.archive")}),danger:!0}].filter(Boolean);return a.jsx(w,{gap:"sm",children:a.jsx(H,{menu:{items:r},trigger:["click"],children:a.jsx(v,{icon:a.jsx(X,{})})})})}),Ct=C(function(){const t=L(),{t:e}=h("campaign"),i=t.campaignsList,r=ut("(max-width: 576px)"),o=m.useMemo(()=>[{key:"title",title:e("table.title"),render:d(({campaign:n})=>a.jsx("div",{className:u.name,children:a.jsx(y,{to:"/campaigns/$campaignId",params:{campaignId:n.id},children:n.name})}))},{key:"title",title:e("table.link"),render:d(n=>{const l=n.campaign;return a.jsxs(a.Fragment,{children:[l.transitLink&&a.jsx(k,{value:l.transitLink}),a.jsx(k,{value:l.landingLink})]})})},{key:"source",title:e("table.source"),render:d(n=>{const l=n.campaign,A={"teasers/native":"purple",facebook:"blue","google adwords":"geekblue",seo:"green","news feed":"volcano",other:"default"};return a.jsx(z,{color:A[l.trafficSource],children:l.trafficSource})}),responsive:["md"]},{key:"createdAt",title:e("table.createdAt"),render:d(({campaign:n})=>a.jsxs(a.Fragment,{children:[a.jsx(g,{value:n.createdAt,dateStyle:"short"}),a.jsx("br",{}),a.jsx("span",{className:u.secondary,children:a.jsx(g,{value:n.createdAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"updatedAt",title:e("table.updatedAt"),render:d(({campaign:n})=>a.jsxs(a.Fragment,{children:[a.jsx(g,{value:n.updatedAt,dateStyle:"short"}),a.jsx("br",{}),a.jsx("span",{className:u.secondary,children:a.jsx(g,{value:n.updatedAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"actions",title:"",render:d(n=>a.jsx(xt,{item:n}))}].filter(Boolean),[e]);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:u.table,children:a.jsx(J,{rowKey:"id",size:r?"small":"large",loading:!i.query.isFetched&&{size:"large"},columns:o,pagination:!1,dataSource:i.data})}),a.jsx("div",{className:u.pagination,children:a.jsx(G,{current:i.currentPage,onChange:i.handlePagination,total:i.total,pageSize:i.limit})})]})}),jt="_card_1eces_1",kt="_body_1eces_1",_t="_head_1eces_6",b={card:jt,body:kt,head:_t},Pt=C(function(){const t=E(),e=D(()=>new mt(t),[t]),i=e.postbackSettings,{t:r}=h("postback"),{t:o}=h("campaign"),{t:c}=h("common");return a.jsx(T.Provider,{value:e,children:a.jsxs(N,{className:b.container,children:[a.jsx(Z,{className:b.card,classNames:{body:b.body,header:b.head},title:a.jsx(tt,{tabBarExtraContent:a.jsxs("div",{style:{display:"flex",gap:8},children:[a.jsx(v,{onClick:e.campaignsList.refresh,loading:e.campaignsList.query.isFetching,icon:a.jsx(et,{})}),a.jsx(v,{onClick:e.globalPostback.detailsToggler.enable,children:r("global")})]}),items:[{key:"active",label:o("tabs.active")},{key:"archive",label:o("tabs.archive")}],accessKey:e.tab,onChange:e.setTab}),children:a.jsx(Ct,{})}),a.jsx(at,{size:"large",open:i.detailsToggler.isEnabled,onClose:i.detailsToggler.disable,title:i.title,extra:a.jsx(w,{justify:"space-between",children:a.jsx(v,{type:"primary",onClick:i.createToggler.enable,children:c("buttons.add")})}),children:a.jsx(K,{model:i})})]})})}),ce=()=>a.jsx(Pt,{});export{ce as component};
