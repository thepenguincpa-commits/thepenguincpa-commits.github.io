import{l as x,_ as C,t as _,a0 as M,o as y,r as d,j as o,U as l,u as w,a1 as k}from"./index.CJpzWARr.js";import{L as R}from"./LayoutContainer.kUniMi3O.js";import{U as b,u as v}from"./usersApi.CVFrqcan.js";import{I as U}from"./InfiniteQueryWithState.DU3fxF3Q.js";import{r as u}from"./renderReactiveCell.D7yC0G9H.js";import{u as P}from"./useTranslation.DVdJGqhZ.js";import{F as A,D as F}from"./Table.CnZn0sov.js";import{P as q}from"./index.C7EzEdlH.js";import{T as L}from"./AntdIcon.BEv94oZ9.js";import{R as S,a as z}from"./ClockCircleOutlined.CyJe1gJd.js";import{T}from"./index.mfBRClzR.js";import{B as j}from"./button.CTAkPJpI.js";import{P as E}from"./index.Dr9pHSB9.js";import{C as N}from"./Input.BJc5rBil.js";import{R as I}from"./SyncOutlined.DPlxgDWy.js";import"./index.B7lSVg36.js";import"./index.5jmBMbM4.js";import"./useClosable.Emosx8Km.js";import"./ActionButton.D2hXE_0n.js";x(()=>C(()=>Promise.resolve().then(()=>ee),void 0));var O=Object.defineProperty,$=(i,t,e)=>t in i?O(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,g=(i,t,e)=>$(i,typeof t!="symbol"?t+"":t,e);class B{constructor(t,e){this.appContext=t,this.listType=e,g(this,"query"),g(this,"limit",10),g(this,"offset",0),_(this,{},{autoBind:!0});const a=t.repositories.get(b);this.query=new U(t.queryClient,{queryKey:this.getQueryKey(),queryFn:async()=>{const s={offset:0,limit:20};return e==="review"?s.status="review":s.managerId=t.auth.account.id,v.getUsers(s)},getNextPageParam:(s,n)=>{const r=n.reduce((c,m)=>c+m.items.length,0);if(!(r>=s.total))return r},initialPageParam:0,transform:({pages:s}={pageParams:[],pages:[]})=>({data:s.flatMap(r=>r.items.map(c=>({id:c.id,data:a.get(c.id).updateFromJson(c),mutation:this.getUpdateMutation(c.id)}))),total:(s[s.length-1]||{total:0}).total}),onError:s=>{t.notify.toastError(s)},placeholderData:s=>s})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}refresh(){this.query.refetch()}getQueryKey(){return["manager-users",this.listType,this.limit,this.offset]}handlePagination(t,e){this.limit=e,this.offset=(t-1)*e,this.query.updateOptions({queryKey:this.getQueryKey()})}getUpdateMutation(t){return new M(this.appContext.queryClient,{mutationFn:async e=>v.patchUsersUserid({userId:t,userAdminUpdate:e}),onSuccess:e=>{this.appContext.repositories.get(b).get(e.id).updateFromJson(e),this.query.invalidate(),this.appContext.notify.toastSuccess({message:"Пользователь успешно обновлен"})},onError:e=>{this.appContext.notify.toastError(e)}})}}var D=Object.defineProperty,K=(i,t,e)=>t in i?D(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,Q=(i,t,e)=>K(i,t+"",e);class W{constructor(t){Q(this,"usersList"),_(this,{},{autoBind:!0}),this.usersList=new B(t,"assigned")}dispose(){console.log("ManagerUsersModel dispose")}init(){console.log("ManagerUsersModel init")}}const J="_card_1k3hr_1",V="_body_1k3hr_1",G="_table_1k3hr_4",H="_pagination_1k3hr_13",p={card:J,body:V,table:G,pagination:H},X=d.memo(function({name:t,onConfirm:e}){const a=d.useRef(null),s=d.useRef(!1);return o.jsx(E,{ref:a,title:`${t}?`,onConfirm:n=>(n?.stopPropagation(),e().then(()=>{s.current=!0,a.current?.popupElement.click()}).catch(()=>{s.current=!1})),onPopupClick:n=>{s.current?s.current=!1:n?.stopPropagation()},onCancel:n=>n?.stopPropagation(),placement:"left",children:o.jsx("div",{onClick:n=>n.stopPropagation(),children:t})})}),Y=y(function({data:t,mutation:e}){const{t:a}=P("users"),s=d.useMemo(()=>({active:a("actions.activate"),blocked:a("actions.block"),frozen:a("actions.freeze"),pending:a("actions.pending"),review:a("actions.review"),rejected:a("actions.reject")}),[a]),n=d.useMemo(()=>{const r=m=>{const f=s[m];return o.jsx(X,{onConfirm:()=>e.mutateAsync({status:m}),name:f})};return{items:[t.status!==l.Active&&{key:l.Active,label:r(l.Active)},![l.Review,l.Pending].includes(t.status)&&{key:l.Review,label:r(l.Review)},t.status!==l.Rejected&&{key:l.Rejected,label:r(l.Rejected)},{type:"divider"},t.status!==l.Frozen&&{key:l.Frozen,label:r(l.Frozen),danger:!0}].filter(Boolean)}},[e,s,t.status]);return o.jsx(F,{menu:n,trigger:["click"],children:o.jsx(j,{children:a("actions.status")})})}),Z=y(function({model:t}){const{t:e}=P("users"),a=t.usersList,s=d.useMemo(()=>[{key:"email",title:e("table.email"),render:u(({data:r})=>o.jsxs(L,{title:r.emailConfirmed?e("table.emailConfirmed"):e("table.emailNotConfirmed"),children:[r.email," ",r.emailConfirmed?o.jsx(S,{style:{color:"var(--ant-color-success)"}}):o.jsx(z,{style:{color:"var(--ant-color-warning)"}})]}))},{key:"telegram",title:e("table.telegram"),render:u(({data:r})=>r.telegram)},{key:"name",title:e("table.name"),render:u(({data:r})=>r.name)},{key:"status",title:e("table.status"),render:u(({data:r})=>{const c={active:e("status.active"),blocked:e("status.blocked"),frozen:e("status.frozen"),pending:e("status.pending"),review:e("status.review"),rejected:e("status.rejected")},f={active:"success",blocked:"error",frozen:"warning",pending:"processing",review:"processing",rejected:"error"}[r.status]||"default";return o.jsx(T,{color:f,children:c[r.status]||r.status})})},{key:"registeredAt",title:e("table.registeredAt"),render:u(({data:r})=>new Date(r.createdAt).toLocaleDateString()),responsive:["md"]},{key:"actions",title:e("table.actions"),render:u(r=>o.jsx(Y,{...r})),fixed:"right"}].filter(Boolean),[e]);return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:p.table,children:o.jsx(A,{rowKey:"id",loading:!a.query.isFetched&&{size:"large"},columns:s,pagination:!1,dataSource:a.data})}),o.jsx("div",{className:p.pagination,children:o.jsx(q,{current:a.currentPage,onChange:a.handlePagination,total:a.total,pageSize:a.limit})})]})}),h=y(function(){const t=w(),e=k(()=>new W(t),[t]);return o.jsx(R,{children:o.jsx(N,{className:p.card,classNames:{body:p.body},title:"Мои пользователи",extra:o.jsx(j,{onClick:e.usersList.refresh,loading:e.usersList.query.isFetching,icon:o.jsx(I,{})}),children:o.jsx(Z,{model:e})})})}),ee=Object.freeze(Object.defineProperty({__proto__:null,ManagerUsers:h,default:h},Symbol.toStringTag,{value:"Module"})),_e=h;export{_e as component};
