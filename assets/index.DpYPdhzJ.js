import{M as _,A as ee,D as y,E as O,F as te,q as F,n as P,p as re,G as c,o as v,j as r,r as x,L as G,u as se}from"./index.D0ZL9dlq.js";import{T as ae,u as ie}from"./useStore.rIWB3VHp.js";import{a as oe}from"./LayoutContainer.D5vzTIRK.js";import{o as j,O as ne,a as le,b as ce,c as ue,d as de,e as J,f as me,B as N,C as he}from"./CountryName.CgLtou_u.js";import{R as U}from"./Registry.DDXooKn4.js";import{I as fe}from"./InfiniteQueryWithState.BoCUIaXG.js";import{O as pe,D as ge}from"./OfferFormModel.D6bDDvqQ.js";import{T as D,M as W}from"./Toggler.DXS98LMk.js";import{I as $,r as k,F as ye,a as d}from"./validators.BorTVuCh.js";import{u as z,a as A,P as be}from"./QueryWithState.BPq9GHGk.js";import{F as H,r as m,D as xe}from"./renderReactiveCell.B_zzU_Pl.js";import{I as w}from"./index.MgSLeBeq.js";import{B as h}from"./button.OEP3CgYZ.js";import{R as je}from"./CheckboxControl.CCdwXOBH.js";import{P as V,F as X,R as Pe}from"./SyncOutlined.BiVJrYuP.js";import{R as ve}from"./DeleteOutlined.BjDLvYpZ.js";import{G as Ce}from"./GridRow.BSx-bdOS.js";import{C as B}from"./row.BNxq_Flf.js";import{C as S}from"./index.ClGRLJ6f.js";import{O as Oe}from"./OfferCategoryName.BvQR0h8I.js";import{D as R}from"./DateFormat.BM9lf7mQ.js";import{u as Y}from"./useTranslation.74tzyRXt.js";import{T as I}from"./index.Bl3kKYWx.js";import{C as we,T as _e}from"./EyeOutlined.BTRVFJFJ.js";import"./index.CA_kN61l.js";import"./SelectControl.DXjBC8yT.js";import"./index.qEyMnBBk.js";var Fe=Object.defineProperty,Te=(a,e,t)=>e in a?Fe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,Q=(a,e,t)=>Te(a,typeof e!="symbol"?e+"":e,t);class Re{constructor(e,t,s,i){this.appContext=e,this.categoriesQuery=t,this.currentItem=s,Q(this,"mutation"),Q(this,"data"),this.data=this.parseData(s),this.mutation=new _(this.appContext.queryClient,{mutationFn:async n=>j.patchOffersId({id:s.id,offerUpdateDto:n}),onSuccess:n=>{this.updateFromJson(n),i.onUpdate(n)}}),ee(this,{data:te.ref,offer:y,category:y,locations:y({equals:O.shallow}),basePayouts:y({equals:O.shallow}),personalPayouts:y({equals:O.shallow}),domains:y({equals:O.shallow}),repositories:y({equals:O.shallow})})}get id(){return this.offer.id}parseData({locations:e,basePayouts:t,personalPayouts:s,domains:i,...n}){const o=this.appContext.repositories.get(ne),u=this.appContext.repositories.get(le),g=this.appContext.repositories.get(ce),C=this.appContext.repositories.get(ue),T=this.appContext.repositories.get(de);return{offer:o.get(n.id).updateFromJson({...n,locations:e.map(l=>l.id),basePayouts:t.map(l=>l.id),personalPayouts:s.map(l=>l.id),domains:i.map(l=>l.id)}),locations:e.map(l=>u.get(l.id).updateFromJson(l)),basePayouts:t.map(l=>g.get(l.id).updateFromJson(l)),personalPayouts:s.map(l=>C.get(l.id).updateFromJson(l)),domains:i.map(l=>T.get(l.id).updateFromJson(l)),offerRepository:o,locationRepository:u,personalPayoutRepository:C,basePayoutRepository:g,domainRepository:T}}get repositories(){return{offer:this.data.offerRepository,locations:this.data.locationRepository,domains:this.data.domainRepository,personalPayouts:this.data.personalPayoutRepository,basePayouts:this.data.basePayoutRepository,categories:this.categoriesQuery.repository}}updateFromJson(e){e!==this.currentItem&&(this.data=this.parseData(e))}get offer(){return this.data.offer}get category(){return this.categoriesQuery.repository.get(this.offer.category)}get locations(){return this.data.locations}get basePayouts(){return this.data.basePayouts}get personalPayouts(){return this.data.personalPayouts}get domains(){return this.data.domains}}var Ie=Object.defineProperty,qe=(a,e,t)=>e in a?Ie(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,q=(a,e,t)=>qe(a,typeof e!="symbol"?e+"":e,t);class E{constructor(e,t){this.status=t,q(this,"query"),q(this,"categoriesQuery"),q(this,"limit",10),q(this,"offset",0),this.categoriesQuery=new J(e);const s=new WeakMap;this.query=new fe(e.queryClient,{queryKey:this.getQueryKey(),queryFn:()=>j.offersGet({status:this.status,offset:0,limit:20}),getNextPageParam:(i,n)=>{const o=n.reduce((u,g)=>u+g.items.length,0);if(!(o>=i.total))return o},initialPageParam:0,transform:({pages:i}={pageParams:[],pages:[]})=>({data:i.flatMap(o=>{let u=s.get(o);return u||(u=new U(g=>new Re(e,this.categoriesQuery,g,{onUpdate:()=>{this.query.invalidate()}}))),u.from(o.items)}),total:(i[i.length-1]||{total:0}).total}),staleTime:1e3*60*5,refetchOnWindowFocus:!0,onError:i=>{F(i).then(n=>{e.notify.error({message:n.message})})},placeholderData:i=>i}),P(this,{},{autoBind:!0})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}refresh(){this.query.refetch()}getQueryKey(){return["admin-offers",this.status,this.limit,this.offset]}handlePagination(e,t){this.limit=t,this.offset=(e-1)*t,this.query.updateOptions({queryKey:this.getQueryKey()})}}var Ae=Object.defineProperty,Se=(a,e,t)=>e in a?Ae(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,M=(a,e,t)=>Se(a,typeof e!="symbol"?e+"":e,t);class Ee{constructor(e,t){this.appConfig=e,M(this,"mutation"),M(this,"form"),M(this,"modalToggler",new D(!1)),P(this,{handleSubmit:re.bound},{autoBind:!0}),this.form=new pe(this.appConfig,()=>null),this.mutation=new _(e.queryClient,{mutationFn:async s=>j.postOffers({offerCreateDto:s}),onSuccess:s=>{this.modalToggler.disable(),t(s)},onError:s=>{F(s).then(i=>{this.appConfig.notify.error({message:i.message||this.t.errors("unknown")})})}})}get t(){return this.appConfig.locale.translations}handleAfterOpenChange(e){e||this.form.group.reset()}handleSubmit(){if(this.form.group.isInvalid){this.form.group.setTouched(!0),this.form.group.setDirty(!0),this.form.group.firstErrorControl?.element?.focus();return}const{image:e,...t}=this.form.group.value;this.mutation.mutate({...t,image:""})}}var Me=Object.defineProperty,Le=(a,e,t)=>e in a?Me(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,L=(a,e,t)=>Le(a,typeof e!="symbol"?e+"":e,t);class Z{constructor(e,t){this.appContext=e,this.initialDataGetter=t,L(this,"nameEn",new $(()=>this.initialData.nameEn,{validators:[k(()=>this.t.forms("required"))]})),L(this,"nameRu",new $(()=>this.initialData.nameRu,{validators:[k(()=>this.t.forms("required"))]})),L(this,"group",new ye({nameEn:this.nameEn,nameRu:this.nameRu})),P(this,{},{autoBind:!0})}get t(){return this.appContext.locale.translations}get initialData(){return this.initialDataGetter()||new me("")}}var De=Object.defineProperty,Ne=(a,e,t)=>e in a?De(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,f=(a,e,t)=>Ne(a,typeof e!="symbol"?e+"":e,t);class $e{constructor(e){f(this,"query"),f(this,"mutation"),f(this,"form"),f(this,"registry"),f(this,"isOpenToggler",new D(!1)),f(this,"selectedItem",""),f(this,"modalFormToggler",new D(!1)),this.registry=new U(t=>new ke(e,t,{onDelete:async()=>{await this.query.refetch()},onUpdate:async()=>{await this.query.refetch(),this.modalFormToggler.disable()}})),this.form=new Z(e,()=>null),this.query=new J(e),this.mutation=new _(e.queryClient,{mutationFn:async()=>{const t=await j.postOfferCategories({offerCategoryCreateDto:this.form.group.value});return await this.query.refetch(),this.modalFormToggler.disable(),t},onError:t=>{F(t).then(s=>{e.notify.error({message:s.message})})}}),P(this,{},{autoBind:!0})}setSelectedItem(e){this.selectedItem=e,this.modalFormToggler.enable()}get selectedItemModel(){return this.categories.find(e=>e.category.id===this.selectedItem)}get categories(){return this.registry.from(this.query.data.items)}handleAfterOpenChange(e){e||(this.selectedItem="",this.form.group.reset())}handleSubmit(){if(this.form.group.isInvalid){this.form.group.setTouched(!0),this.form.group.setDirty(!0),this.form.group.firstErrorControl?.element?.focus();return}return this.mutation.mutate()}}class ke{constructor(e,t,s){this.appContext=e,this.category=t,this.props=s,f(this,"deleteMutation"),f(this,"mutation"),f(this,"form"),this.form=new Z(e,()=>t),this.mutation=new _(e.queryClient,{mutationFn:async()=>{await j.patchOfferCategories({id:t.id,offerCategoryCreateDto:this.form.group.value}),await s.onUpdate()},onError:i=>{F(i).then(n=>{e.notify.error({message:n.message})})}}),this.deleteMutation=new _(e.queryClient,{mutationFn:async()=>{await j.deleteOfferCategories({id:t.id}),await s.onDelete()},onError:i=>{F(i).then(n=>{e.notify.error({message:n.message})})}}),P(this,{},{autoBind:!0})}get id(){return this.category.id}async handleSubmit(){if(this.form.group.isInvalid){this.form.group.setTouched(!0),this.form.group.setDirty(!0),this.form.group.firstErrorControl?.element?.focus();return}return this.mutation.mutate()}async handleDelete(){return this.deleteMutation.mutate()}}var Be=Object.defineProperty,Qe=(a,e,t)=>e in a?Be(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,b=(a,e,t)=>Qe(a,typeof e!="symbol"?e+"":e,t);class Ke{constructor(e){b(this,"createModal"),b(this,"activeList"),b(this,"pausedList"),b(this,"archivedList"),b(this,"categoriesSettings"),b(this,"tab",c.Active),this.activeList=new E(e,c.Active),this.pausedList=new E(e,c.Paused),this.archivedList=new E(e,c.Archived),this.categoriesSettings=new $e(e),this.createModal=new Ee(e,()=>{this.activeList.query.invalidate(),this.pausedList.query.invalidate(),this.archivedList.query.invalidate()}),P(this,{},{autoBind:!0})}setTab(e){this.tab=e}get offersList(){return this.tab===c.Paused?this.pausedList:this.tab===c.Archived?this.archivedList:this.activeList}handleAddOffer(){this.createModal.modalToggler.enable()}dispose(){console.log("dispose")}init(){console.log("init")}}const Ge="_card_hbmmy_1",Je="_body_hbmmy_1",Ue="_table_hbmmy_4",We="_pagination_hbmmy_13",ze="_tags_hbmmy_19",He="_secondary_hbmmy_25",p={card:Ge,body:Je,table:Ue,pagination:We,tags:ze,secondary:He},K=v(function({form:e,handleSubmit:t}){return r.jsxs(d,{layout:"vertical",onFinish:t,children:[r.jsx(d.Item,{label:"Название (EN)",...e.nameEn.itemProps,children:r.jsx(w,{placeholder:"Введите название (EN)",...e.nameEn.inputProps})}),r.jsx(d.Item,{label:"Название (EN)",...e.nameRu.itemProps,children:r.jsx(w,{placeholder:"Введите название (EN)",...e.nameRu.inputProps})})]})}),Ve=v(function({model:e}){const{t}=z("offer"),s=e.categories,i=[{title:"Название (EN)",render:m(({category:n})=>n.nameRu)},{title:"Название (RU)",render:m(({category:n})=>n.nameRu)},{title:"Действия",render:m(n=>r.jsxs(N,{gap:"xs",children:[r.jsx(h,{icon:r.jsx(je,{}),onClick:()=>e.setSelectedItem(n.id)}),r.jsx(V,{title:"Удалить категорию?",onConfirm:n.handleDelete,placement:"left",children:r.jsx(h,{danger:!0,icon:r.jsx(ve,{})})})]}))}];return r.jsxs(r.Fragment,{children:[r.jsx(H,{columns:i,dataSource:s,rowKey:"id",pagination:!1,sticky:!0}),r.jsx(W,{destroyOnHidden:!0,open:e.modalFormToggler.isEnabled,onCancel:e.modalFormToggler.disable,maskClosable:!1,afterOpenChange:e.handleAfterOpenChange,footer:r.jsxs(N,{gap:"sm",justify:"end",children:[r.jsx(h,{onClick:e.modalFormToggler.disable,children:t("buttons.cancel",{ns:"common"})}),e.selectedItemModel?r.jsx(h,{type:"primary",loading:e.selectedItemModel.mutation.isPending,onClick:e.selectedItemModel.handleSubmit,children:t("buttons.submit",{ns:"common"})}):r.jsx(h,{type:"primary",loading:e.mutation.isPending,onClick:e.handleSubmit,children:t("buttons.submit",{ns:"common"})})]}),centered:!0,children:e.selectedItemModel?r.jsx(K,{form:e.selectedItemModel.form,handleSubmit:e.selectedItemModel.handleSubmit}):r.jsx(K,{form:e.form,handleSubmit:e.handleSubmit})})]})}),Xe=v(function({model:e}){const{t}=z("offer"),s=e.form;return r.jsx(W,{title:t("form.formName"),destroyOnHidden:!0,open:e.modalToggler.isEnabled,onCancel:e.modalToggler.disable,maskClosable:!1,afterOpenChange:e.handleAfterOpenChange,footer:r.jsxs(X,{gap:"small",justify:"flex-end",children:[r.jsx(h,{onClick:e.modalToggler.disable,children:t("buttons.cancel",{ns:"common"})}),r.jsx(h,{type:"primary",loading:e.mutation.isPending,onClick:e.handleSubmit,disabled:!s.group.isChanged,children:t("buttons.submit",{ns:"common"})})]}),width:800,centered:!0,children:r.jsx(d,{layout:"vertical",onFinish:e.handleSubmit,children:r.jsxs(Ce,{children:[r.jsxs(B,{xs:24,md:12,children:[r.jsx(d.Item,{label:t("form.titleLabel"),...s.title.itemProps,children:r.jsx(w,{placeholder:t("form.titlePlaceholder"),...s.title.inputProps})}),r.jsx(d.Item,{label:t("form.subtitleLabel"),...s.subtitle.itemProps,children:r.jsx(w,{placeholder:t("form.subtitlePlaceholder"),...s.subtitle.inputProps})}),r.jsx(d.Item,{label:t("form.rulesLabel"),...s.rules.itemProps,children:r.jsx(w.TextArea,{placeholder:t("form.rulesPlaceholder"),...s.rules.inputProps,rows:9})})]}),r.jsxs(B,{xs:24,md:12,children:[r.jsx(d.Item,{label:t("form.verticalLabel"),...s.vertical.itemProps,children:r.jsx(A,{placeholder:t("form.verticalPlaceholder"),optionFilterProp:"label",showSearch:!0,...s.vertical.inputProps})}),r.jsx(d.Item,{label:t("form.categoryLabel"),...s.category.itemProps,children:r.jsx(A,{placeholder:t("form.categoryPlaceholder"),...s.category.inputProps})}),r.jsx(d.Item,{label:t("form.statusLabel"),...s.status.itemProps,children:r.jsx(A,{placeholder:t("form.statusPlaceholder"),...s.status.inputProps})}),r.jsx(d.Item,{...s.accessOnRequest.itemProps,children:r.jsx(S,{...s.accessOnRequest.inputProps,children:t("form.accessOnRequestLabel")})}),r.jsx(d.Item,{...s.isTest.itemProps,children:r.jsx(S,{...s.isTest.inputProps,children:t("form.isTestLabel")})}),r.jsx(d.Item,{...s.isExclusive.itemProps,children:r.jsx(S,{...s.isExclusive.inputProps,children:t("form.isExclusiveLabel")})})]})]})})})}),Ye=x.memo(function({name:e,onConfirm:t}){const s=x.useRef(null),i=x.useRef(!1);return r.jsx(V,{ref:s,title:`${e}?`,onConfirm:n=>(n?.stopPropagation(),t().then(()=>{i.current=!0,s.current?.popupElement.click()}).catch(()=>{i.current=!1})),onPopupClick:n=>{i.current?i.current=!1:n?.stopPropagation()},onCancel:n=>n?.stopPropagation(),placement:"left",children:r.jsx("div",{onClick:n=>n.stopPropagation(),children:e})})}),Ze=v(function({item:e}){const{offer:t,mutation:s}=e,{t:i}=Y("offer"),n=x.useMemo(()=>({active:i("actions.activate"),paused:i("actions.pause"),archived:i("actions.archive")}),[i]),o=x.useMemo(()=>{const u=C=>{const T=n[C];return r.jsx(Ye,{onConfirm:()=>s.mutateAsync({status:C}),name:T})};return{items:[{key:"edit",label:r.jsx(G,{to:"/admin/offers/$offerId",params:{offerId:t.id},children:i("actions.edit")})},t.status!==c.Active&&{key:c.Active,label:u(c.Active)},t.status!==c.Paused&&{key:c.Paused,label:u(c.Paused)},t.status!==c.Archived&&{key:"divider",type:"divider"},t.status!==c.Archived&&{key:c.Archived,label:u(c.Archived),danger:!0}].filter(Boolean)}},[t.status,t.id,s,n,i]);return r.jsx(X,{gap:"small",children:r.jsx(xe,{menu:o,trigger:["click"],children:r.jsx(h,{children:i("actions.detail")})})})}),et=v(function({page:e}){const{t}=Y("offer"),s=e.offersList,i=x.useMemo(()=>[{key:"title",title:t("table.title"),render:m(({offer:o})=>r.jsx(G,{to:"/admin/offers/$offerId",params:{offerId:o.id},children:o.title}))},{key:"vertical",title:t("table.vertical"),render:m(({offer:o})=>t(`vertical.${o.vertical}`))},{key:"category",title:t("table.category"),render:m(({category:o})=>r.jsx(Oe,{category:o}))},{key:"tags",title:t("table.tags"),render:m(({offer:o})=>r.jsxs("div",{className:p.tags,children:[o.accessOnRequest&&r.jsx(I,{color:"error",children:t("status.accessOnRequest")}),o.isExclusive&&r.jsx(I,{color:"purple",children:t("status.isExclusive")}),o.isTopOffer&&r.jsx(I,{color:"blue",children:t("status.isTopOffer")}),o.isTest&&r.jsx(I,{color:"warning",children:t("status.isTest")})]}))},{key:"cr",title:t("table.cr"),render:m(({offer:o})=>o.cr)},{key:"approve",title:t("table.approve"),render:m(({offer:o})=>o.approve)},{key:"languages",title:t("table.languages"),render:m(({locations:o})=>r.jsx(ae,{overlay:r.jsx(r.Fragment,{children:o.map(u=>r.jsxs(r.Fragment,{children:[r.jsx(he,{code:u.countryCode})," ",r.jsx("br",{})]}))}),children:r.jsx("div",{children:o.length})}))},{key:"createdAt",title:t("table.createdAt"),render:m(({offer:o})=>r.jsxs(r.Fragment,{children:[r.jsx(R,{value:o.createdAt,dateStyle:"short"}),r.jsx("br",{}),r.jsx("span",{className:p.secondary,children:r.jsx(R,{value:o.createdAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"updatedAt",title:t("table.updatedAt"),render:m(({offer:o})=>r.jsxs(r.Fragment,{children:[r.jsx(R,{value:o.updatedAt,dateStyle:"short"}),r.jsx("br",{}),r.jsx("span",{className:p.secondary,children:r.jsx(R,{value:o.updatedAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"actions",title:t("table.actions"),render:m(o=>r.jsx(Ze,{item:o})),fixed:"right"}].filter(Boolean),[t]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:p.table,children:r.jsx(H,{rowKey:"id",loading:!s.query.isFetched&&{size:"large"},columns:i,pagination:!1,dataSource:s.data})}),r.jsx("div",{className:p.pagination,children:r.jsx(be,{current:s.currentPage,onChange:s.handlePagination,total:s.total,pageSize:s.limit})})]})}),tt=v(function(){const e=se(),t=ie(()=>new Ke(e),[e]),s=t.categoriesSettings;return r.jsxs(oe,{children:[r.jsx(Xe,{model:t.createModal}),r.jsx(we,{className:p.card,classNames:{body:p.body},title:r.jsx(_e,{tabBarExtraContent:r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsx(h,{onClick:t.offersList.refresh,loading:t.offersList.query.isFetching,icon:r.jsx(Pe,{})}),r.jsx(h,{onClick:s.isOpenToggler.enable,children:"Настройки категорий"}),r.jsx(h,{type:"primary",onClick:t.handleAddOffer,children:"Добавить оффер"})]}),items:[{key:c.Active,label:"Активные"},{key:c.Paused,label:"На паузе"},{key:c.Archived,label:"Архив"}],accessKey:t.tab,onChange:t.setTab}),children:r.jsx(et,{page:t})}),r.jsx(ge,{size:"large",className:p.card,classNames:{body:p.body},open:s.isOpenToggler.isEnabled,onClose:s.isOpenToggler.disable,extra:r.jsx(h,{type:"primary",onClick:s.modalFormToggler.enable,children:"Добавить категорию"}),children:r.jsx(Ve,{model:s})})]})}),Rt=tt;export{Rt as component};
