import{t as _,o as L,r as u,f as B,j as e,a4 as Q,O as G,e as H,al as y,u as U,a1 as W}from"./index.WsYO2dy-.js";import{G as V,d as F,D as J}from"./index.CfoN1hn6.js";import{u as X}from"./useTranslation.Bt2PYRL2.js";import{R as Z}from"./AppLayout.DyHuBULn.js";import{L as tt}from"./LayoutContainer.CsWPLRk4.js";import{w as A,R as et,a as q}from"./webmasterStatsApi.CDa-A2Cm.js";import{I as O}from"./InfiniteQueryWithState.DXgnPzYl.js";import{B as R}from"./Box.BoA2lbt8.js";import{C as P}from"./CountryName.CtqEwQTt.js";import{D}from"./DateFormat.DX8kRgXq.js";import{F as $}from"./FlagIcon.Canhu2ph.js";import{u as N}from"./useTranslation.D4fSpiLe.js";import{T as st}from"./index.D7q-MwFy.js";import{B as z}from"./button.B3PsbA3S.js";import{D as c}from"./index.CZ1OK7Vi.js";import{F as E}from"./Table.Dku94qg-.js";import{P as Y}from"./index.DGsLj2m-.js";import{T as m}from"./AntdIcon.vojNxC2w.js";import{R as k,a as K}from"./ClockCircleOutlined.BwMz-DBT.js";import{C as M,T as at}from"./Input.CS61qdQu.js";import{R as it}from"./SyncOutlined.BuXhQB6u.js";import{R as nt,C as x}from"./row.C2dg1pTq.js";import{S as v}from"./index.DNnqjxYK.js";import"./index.BAyObCzF.js";import"./useClosable.D4JC76of.js";import"./index.DLZ010Vy.js";var rt=Object.defineProperty,ot=(n,s,t)=>s in n?rt(n,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[s]=t,g=(n,s,t)=>ot(n,typeof s!="symbol"?s+"":s,t);const lt=()=>{const n=new Date;return n.setDate(n.getDate()-7),n.toISOString().split("T")[0]},dt=()=>new Date().toISOString().split("T")[0];class ct{constructor(s){g(this,"dateFrom",lt()),g(this,"dateTo",dt()),g(this,"offset",0),g(this,"limit",50),g(this,"query"),_(this,{query:!1,queryKey:!0},{autoBind:!0}),this.query=new O(s.queryClient,{queryKey:this.queryKey,queryFn:async()=>{const t={offset:this.offset,limit:this.limit};return this.dateFrom&&(t.from=this.dateFrom),this.dateTo&&(t.to=this.dateTo),A.getStatsByConversion(t)},getNextPageParam:()=>{},initialPageParam:0,transform:({pages:t}={pageParams:[],pages:[]})=>{const a=t[t.length-1];return{items:a?.items||[],total:a?.total||0}},onError:t=>{s.notify.toastError(t)},staleTime:1e3*60,enabled:!1,placeholderData:t=>t})}get queryKey(){return["advertiser","stats","conversions",this.dateFrom,this.dateTo,this.offset,this.limit]}setDateRange(s,t){this.dateFrom=s,this.dateTo=t,this.query.updateOptions({queryKey:this.queryKey})}handlePagination(s,t){this.offset=(s-1)*t,this.limit=t,this.query.updateOptions({queryKey:this.queryKey})}refresh(){this.query.refetch()}get items(){return this.query.data.items}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}enableQuery(){this.query.isFetched||(this.query.updateOptions({enabled:!0}),this.query.refetch())}}var ht=Object.defineProperty,ut=(n,s,t)=>s in n?ht(n,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[s]=t,b=(n,s,t)=>ut(n,typeof s!="symbol"?s+"":s,t);const yt=()=>{const n=new Date;return n.setDate(n.getDate()-7),n.toISOString().split("T")[0]},pt=()=>new Date().toISOString().split("T")[0];class mt{constructor(s){b(this,"dateFrom",yt()),b(this,"dateTo",pt()),b(this,"offset",0),b(this,"limit",20),b(this,"query"),_(this,{query:!1,queryKey:!0},{autoBind:!0}),this.query=new O(s.queryClient,{queryKey:this.queryKey,queryFn:async()=>{const t={};return this.dateFrom&&(t.from=this.dateFrom),this.dateTo&&(t.to=this.dateTo),A.getStatsByDay(t)},getNextPageParam:()=>{},initialPageParam:0,transform:({pages:t}={pageParams:[],pages:[]})=>{const a=t.flatMap(p=>p.items),r=t[t.length-1];return{allItems:a,total:r?.total}},onError:t=>{s.notify.toastError(t)},staleTime:1e3*60,placeholderData:t=>t})}get queryKey(){return["advertiser","stats","daily",this.dateFrom,this.dateTo]}setDateRange(s,t){this.dateFrom=s,this.dateTo=t,this.offset=0,this.query.updateOptions({queryKey:this.queryKey})}handlePagination(s,t){this.offset=(s-1)*t,this.limit=t}refresh(){this.query.refetch()}get allItems(){return this.query.data.allItems}get items(){return this.allItems.slice(this.offset,this.offset+this.limit)}get totalItems(){return this.allItems.length}get currentPage(){return Math.floor(this.offset/this.limit)+1}get total(){return this.query.data.total}}var ft=Object.defineProperty,xt=(n,s,t)=>s in n?ft(n,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[s]=t,C=(n,s,t)=>xt(n,typeof s!="symbol"?s+"":s,t);class vt{constructor(s){C(this,"dailyStatsList"),C(this,"conversionsList"),C(this,"tab","daily"),_(this,{},{autoBind:!0}),this.dailyStatsList=new mt(s),this.conversionsList=new ct(s)}setTab(s){this.tab=s}get activeList(){return this.tab==="conversions"?this.conversionsList:this.dailyStatsList}dispose(){}init(){}}const gt="_container_1pisw_1",bt="_statsCard_1pisw_5",jt="_card_1pisw_9",St="_body_1pisw_13",wt="_table_1pisw_17",It="_pagination_1pisw_28",Dt="_secondary_1pisw_52",h={container:gt,statsCard:bt,card:jt,body:St,table:wt,pagination:It,secondary:Dt},Ct={[y.Approved]:"green",[y.Pending]:"orange",[y.Rejected]:"red",[y.Trash]:"default"},_t=L(function({model:s}){const{t}=N("stats"),[a]=u.useState(()=>B.set()),r=u.useCallback(i=>{a.has(i)?a.delete(i):a.add(i)},[a]),p=u.useMemo(()=>[{title:t("conversions.table.date"),dataIndex:"createdAt",key:"createdAt",width:72,render:i=>e.jsxs(e.Fragment,{children:[e.jsx(D,{value:i,dateStyle:"short"}),e.jsx("br",{}),e.jsx("span",{className:h.secondary,children:e.jsx(D,{value:i,timeStyle:"short"})})]})},{title:t("conversions.table.status"),dataIndex:["status","type"],key:"status",width:100,render:i=>{const l={[y.Approved]:"conversions.status.approved",[y.Pending]:"conversions.status.pending",[y.Rejected]:"conversions.status.rejected",[y.Trash]:"conversions.status.trash"}[i]||"conversions.status.pending";return e.jsx(st,{color:Ct[i],children:t(l)})}},{title:t("conversions.table.offer"),dataIndex:["offer","name"],key:"offer",width:150,ellipsis:!0,render:i=>e.jsx(Q,{to:"/advertiser/offers",style:{color:"#1890ff"},children:i})},{title:t("conversions.table.landing"),dataIndex:["landing","name"],key:"landing",width:100,ellipsis:!0,responsive:["lg"],render:i=>i||t("conversions.table.noData")},{title:t("conversions.table.transit"),dataIndex:["transit","name"],key:"transit",width:100,ellipsis:!0,responsive:["lg"],render:i=>i||t("conversions.table.noData")},{title:t("conversions.table.country"),dataIndex:["geo","country"],key:"country",width:120,responsive:["sm"],render:i=>i?e.jsxs(R,{gap:"xs",align:"center",nowrap:!0,children:[e.jsx($,{code:i}),e.jsx(P,{code:i})]}):t("conversions.table.noData")},{title:t("conversions.table.city"),dataIndex:["geo","city"],key:"city",width:100,ellipsis:!0,responsive:["md"],render:i=>i||t("conversions.table.noData")},{title:t("conversions.table.contacts"),key:"contacts",width:120,ellipsis:!0,responsive:["lg"],render:(i,o)=>{const{name:l,phone:f}=o.client;return!l&&!f?t("conversions.table.noData"):e.jsxs(e.Fragment,{children:[l,e.jsx("br",{}),f]})}},{key:"expand",width:52,render:(i,o)=>e.jsx(G,{children:()=>{const l=a.has(o.id);return e.jsx(z,{type:"text",size:"small",icon:l?e.jsx(et,{}):e.jsx(Z,{}),onClick:()=>r(o.id)})}})}],[a,r,t]),d=V.useBreakpoint(),S=u.useMemo(()=>{let i=950;return d.xs&&(i=500),d.sm&&(i=650),d.md&&(i=800),{x:i}},[d.xs,d.sm,d.md]),j=u.useMemo(()=>H(()=>Array.from(a.values())),[a]).get(),w=u.useMemo(()=>{const i=()=>d.xs?1:d.sm||d.md?2:4;return{showExpandColumn:!1,expandedRowKeys:j,onExpandedRowsChange:o=>{a.replace(o)},expandIcon:()=>null,expandedRowRender:o=>e.jsxs(c,{size:"small",column:i(),bordered:!0,children:[e.jsx(c.Item,{label:t("conversions.table.id"),children:o.id}),e.jsx(c.Item,{label:t("conversions.table.ip"),children:o.technical.ip}),e.jsx(c.Item,{label:t("conversions.table.country"),children:o.geo.country?e.jsxs(R,{gap:"xs",align:"center",nowrap:!0,children:[e.jsx($,{code:o.geo.country}),e.jsx(P,{code:o.geo.country})]}):t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.city"),children:o.geo.city||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.name"),children:o.client.name||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.phone"),children:o.client.phone||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.callsCount"),children:o.client.calls_count}),e.jsx(c.Item,{label:t("conversions.table.firstCalledAt"),children:o.client.firstCalledAt?e.jsx(D,{value:o.client.firstCalledAt,dateStyle:"short",timeStyle:"short"}):t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.gender"),children:o.client.gender||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.age"),children:o.client.age||t("conversions.table.noData")})]})}},[j,d,a,t]),I=u.useMemo(()=>s.conversionsList.query.isFetching?{spinning:!0,tip:t("conversions.loading")}:!1,[s.conversionsList.query.isFetching,t]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:h.table,children:e.jsx(E,{size:"small",columns:p,dataSource:s.conversionsList.items,loading:I,rowKey:"id",pagination:!1,scroll:S,bordered:!0,expandable:w})}),e.jsxs("div",{className:h.pagination,children:[e.jsxs("div",{style:{marginRight:"auto"},children:[t("conversions.total"),": ",s.conversionsList.total]}),e.jsx(Y,{current:s.conversionsList.currentPage,pageSize:s.conversionsList.limit,total:s.conversionsList.total,showSizeChanger:!0,onChange:(i,o)=>s.conversionsList.handlePagination(i,o)})]})]})}),Lt=L(function({model:s}){const{t}=N("stats"),a=u.useMemo(()=>[{title:t("dailyStats.table.date"),dataIndex:"date",key:"date",fixed:"left",render:r=>new Date(r).toLocaleDateString("ru-RU"),width:72},{title:t("dailyStats.table.hits"),dataIndex:["traffic","hits"],key:"hits",width:64},{title:t("dailyStats.table.hosts"),dataIndex:["traffic","hosts"],key:"hosts",width:64},{title:t("dailyStats.table.transitions"),dataIndex:["traffic","transitions"],key:"transitions",width:64},{title:t("dailyStats.table.conversions"),children:[{title:e.jsx(m,{title:t("dailyStats.tooltip.accepted"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(k,{style:{color:"#52c41a",fontSize:"16px"}})})}),dataIndex:["conversions","accepted"],key:"accepted",width:52},{title:e.jsx(m,{title:t("dailyStats.tooltip.pending"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(K,{style:{color:"#faad14",fontSize:"16px"}})})}),dataIndex:["conversions","pending"],key:"pending",width:52},{title:e.jsx(m,{title:t("dailyStats.tooltip.declined"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(q,{style:{color:"#ff4d4f",fontSize:"16px"}})})}),dataIndex:["conversions","declined"],key:"declined",width:52},{title:e.jsx(m,{title:t("dailyStats.tooltip.total"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx("span",{style:{fontSize:"16px",fontWeight:"bold"},children:"Σ"})})}),dataIndex:["conversions","total"],key:"total",width:52}]},{title:t("dailyStats.table.coefficients"),children:[{title:t("dailyStats.table.epc"),dataIndex:["coefficients","epc"],key:"epc",width:52,render:r=>`$${r.toFixed(2)}`},{title:t("dailyStats.table.crl"),dataIndex:["coefficients","crl"],key:"crl",width:52,render:r=>`${r.toFixed(2)}%`},{title:t("dailyStats.table.crs"),dataIndex:["coefficients","crs"],key:"crs",width:52,render:r=>`${r.toFixed(2)}%`},{title:t("dailyStats.table.approval"),dataIndex:["coefficients","approval"],key:"approval",width:52,render:r=>`${r.toFixed(2)}%`}]},{title:t("dailyStats.table.revenue"),children:[{title:e.jsx(m,{title:t("dailyStats.tooltip.acceptedRevenue"),placement:"top",overlayStyle:{pointerEvents:"none"},children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(k,{style:{color:"#52c41a",fontSize:"16px"}})})}),dataIndex:["revenue","accepted"],key:"accepted_revenue",width:64,render:r=>`$${r.toFixed(2)}`},{title:e.jsx(m,{title:t("dailyStats.tooltip.pendingRevenue"),placement:"top",overlayStyle:{pointerEvents:"none"},children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(K,{style:{color:"#faad14",fontSize:"16px"}})})}),dataIndex:["revenue","pending"],key:"pending_revenue",width:64,render:r=>`$${r.toFixed(2)}`},{title:e.jsx(m,{title:t("dailyStats.tooltip.declinedRevenue"),placement:"top",overlayStyle:{pointerEvents:"none"},children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(q,{style:{color:"#ff4d4f",fontSize:"16px"}})})}),dataIndex:["revenue","declined"],key:"declined_revenue",width:64,render:r=>`$${r.toFixed(2)}`}]}],[t]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:h.table,children:e.jsx(E,{size:"small",columns:a,dataSource:s.dailyStatsList.items,loading:s.dailyStatsList.query.isFetching?{spinning:!0,tip:t("dailyStats.loading")}:!1,rowKey:"date",pagination:!1,scroll:{x:1500},bordered:!0})}),e.jsxs("div",{className:h.pagination,children:[e.jsxs("div",{style:{marginRight:"auto"},children:[t("dailyStats.totalDays"),": ",s.dailyStatsList.totalItems]}),e.jsx(Y,{current:s.dailyStatsList.currentPage,pageSize:s.dailyStatsList.limit,total:s.dailyStatsList.totalItems,showSizeChanger:!0,onChange:(r,p)=>s.dailyStatsList.handlePagination(r,p)})]})]})}),{RangePicker:Tt}=J,Ft=L(function(){const s=U(),{t}=X("stats"),a=W(()=>new vt(s),[s]),r=a.dailyStatsList.total,p=r?.traffic.hits||0,d=r?.traffic.hosts||0,S=r?.traffic.transitions||0,j=r?.conversions.total||0,w=(r?.revenue.accepted||0)+(r?.revenue.pending||0),I=a.dailyStatsList.dateFrom&&a.dailyStatsList.dateTo?[F(a.dailyStatsList.dateFrom),F(a.dailyStatsList.dateTo)]:null,i=l=>{if(l&&l[0]&&l[1]){const f=l[0].format("YYYY-MM-DD"),T=l[1].format("YYYY-MM-DD");a.dailyStatsList.setDateRange(f,T),a.conversionsList.setDateRange(f,T)}else a.dailyStatsList.setDateRange(void 0,void 0),a.conversionsList.setDateRange(void 0,void 0)},o=l=>{a.setTab(l),l==="conversions"&&a.conversionsList.enableQuery()};return e.jsxs(tt,{className:h.container,children:[e.jsx(M,{className:h.card,classNames:{body:h.body},title:e.jsx(at,{tabBarExtraContent:e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(Tt,{value:I,onChange:i,format:"DD.MM.YYYY",placeholder:[t("dateRange.startDate"),t("dateRange.endDate")]}),e.jsx(z,{onClick:a.activeList.refresh,loading:a.activeList.query.isFetching,icon:e.jsx(it,{})})]}),items:[{key:"daily",label:t("tabs.daily")},{key:"conversions",label:t("tabs.conversions")}],activeKey:a.tab,onChange:o}),children:a.tab==="daily"?e.jsx(Lt,{model:a}):e.jsx(_t,{model:a})}),a.tab==="daily"&&a.dailyStatsList.items.length>0&&e.jsx(M,{className:h.statsCard,size:"small",title:t("summary.title"),children:e.jsxs(nt,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(v,{title:t("summary.hits"),value:p})}),e.jsx(x,{span:6,children:e.jsx(v,{title:t("summary.hosts"),value:d})}),e.jsx(x,{span:6,children:e.jsx(v,{title:t("summary.transitions"),value:S})}),e.jsx(x,{span:6,children:e.jsx(v,{title:t("summary.conversions"),value:j})}),e.jsx(x,{span:6,children:e.jsx(v,{title:t("summary.revenue"),value:w,precision:2,prefix:"$"})})]})})]})}),ae=Ft;export{ae as component};
