import{l as G,_ as J,a as H,r as n,t as k,S as X,a2 as d,a0 as Z,a3 as ee,o as z,j as s,a4 as te,u as se,a1 as I}from"./index.WsYO2dy-.js";import{u as O}from"./useTranslation.Bt2PYRL2.js";import"./AppLayout.DyHuBULn.js";import{L as ae}from"./LayoutContainer.CsWPLRk4.js";import{P as oe,a as Q,R as re}from"./adminPayoutsApi.BH_YztJM.js";import{U as ie}from"./usersApi.B6WEsVtH.js";import{T as le}from"./Toggler.ZA2mSsXC.js";import{r as ne,I as ue,a as de,b as C}from"./validators.Dv5Q2cT2.js";import{S as me}from"./SelectControl.C52l_hTY.js";import{r as pe}from"./renderReactiveCell.wysBt9wO.js";import{D as T}from"./DateFormat.DX8kRgXq.js";import{G as ce,D as he}from"./index.CfoN1hn6.js";import{T as _}from"./index.D7q-MwFy.js";import{D as ye,S as A,F as ge}from"./Table.Dku94qg-.js";import{B as y}from"./button.B3PsbA3S.js";import{R as be}from"./MoreOutlined.8fhyFFDm.js";import{I as v}from"./index.BtpR5D5L.js";import{S as w}from"./index.DGsLj2m-.js";import{C as fe}from"./Input.CS61qdQu.js";import{D as xe}from"./index.DgS7zglb.js";import{M as Fe}from"./index.BeMCciVP.js";import{F as Ce}from"./index.BJrxXEaZ.js";import"./index.BAyObCzF.js";import"./AntdIcon.vojNxC2w.js";import"./row.C2dg1pTq.js";import"./useClosable.D4JC76of.js";import"./index.DLZ010Vy.js";import"./EyeOutlined.ugoREuIH.js";import"./ActionButton.DSiJnkeb.js";import"./index.C9s0pYnk.js";G(()=>Promise.all([J(()=>Promise.resolve().then(()=>ze),void 0),H("common")]).then(r=>({default:r[0].AdminPayouts})));var ve=Object.defineProperty,we=(r,o,e)=>o in r?ve(r,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[o]=e,u=(r,o,e)=>we(r,typeof o!="symbol"?o+"":o,e);class Se{constructor(o){u(this,"payoutsQuery"),u(this,"payoutRequestRepository"),u(this,"userRepository"),u(this,"page",0),u(this,"pageSize",20),u(this,"statusFilter"),u(this,"webmasterIdFilter"),u(this,"dateFromFilter"),u(this,"dateToFilter"),u(this,"setPage",e=>{this.page=e,this.payoutsQuery.refetch()}),u(this,"setStatusFilter",e=>{this.statusFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"setWebmasterIdFilter",e=>{this.webmasterIdFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"setDateFromFilter",e=>{this.dateFromFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"setDateToFilter",e=>{this.dateToFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"clearFilters",()=>{this.statusFilter=void 0,this.webmasterIdFilter=void 0,this.dateFromFilter=void 0,this.dateToFilter=void 0,this.page=0,this.payoutsQuery.refetch()}),k(this,{},{autoBind:!0}),this.userRepository=o.repositories.get(ie),this.payoutRequestRepository=o.repositories.get(oe,this.userRepository),this.payoutsQuery=new X(o.queryClient,{queryKey:["admin","payouts",this.page,this.statusFilter,this.webmasterIdFilter,this.dateFromFilter,this.dateToFilter],queryFn:()=>Q.getAllPayouts({offset:this.page*this.pageSize,limit:this.pageSize,status:this.statusFilter,webmasterId:this.webmasterIdFilter,dateFrom:this.dateFromFilter,dateTo:this.dateToFilter}),transform:e=>e?{items:e.items.map(l=>{const c=this.payoutRequestRepository.get(l.id);c.updateFromJson(l);const a=this.userRepository.get(c.webmasterId).updateFromJson(e.users.find(h=>h.id===c.webmasterId)||{name:"Вебмастер",email:"dzhaweb@mail.com"});return{payout:c,webmaster:a}})}:{items:[]},staleTime:1e3*30})}dispose(){}init(){}}const q=n.createContext(null);function je(){const r=n.useContext(q);if(!r)throw new Error("Необходимо зарегистрировать провайдер AdminPayoutsModelContext");return r}var Pe=Object.defineProperty,Ie=(r,o,e)=>o in r?Pe(r,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[o]=e,p=(r,o,e)=>Ie(r,typeof o!="symbol"?o+"":o,e);class Te{constructor(o,e){this.onSuccess=e,p(this,"modalToggler",new le(!1)),p(this,"updateMutation"),p(this,"payoutId",null),p(this,"status",new me("pending",{validators:[ne(()=>"Выберите статус")],options:()=>[{label:"Ожидает",value:d.Pending},{label:"Одобрено",value:d.Approved},{label:"Отклонено",value:d.Rejected}]})),p(this,"managerComment",new ue("",{validators:[]})),p(this,"group",new de({status:this.status,managerComment:this.managerComment})),p(this,"openModal",(t,l)=>{this.payoutId=t,this.status.setValue(l),this.modalToggler.enable()}),p(this,"handleAfterOpenChange",t=>{t||(this.group.reset(),this.payoutId=null)}),p(this,"handleSubmit",async()=>{if(this.group.isInvalid){this.group.setTouched(!0),this.group.setDirty(!0),this.group.firstErrorControl?.element?.focus();return}this.payoutId&&await this.updateMutation.mutate({payoutId:this.payoutId,status:this.status.value,managerComment:this.managerComment.value||void 0})}),k(this,{},{autoBind:!0}),this.updateMutation=new Z(o.queryClient,{mutationFn:async t=>Q.updatePayoutRequest({payoutId:t.payoutId,payoutRequestUpdateDto:{status:t.status,managerComment:t.managerComment}}),onSuccess:()=>{ee(()=>{this.modalToggler.disable(),this.group.reset(),this.onSuccess()})},resetOnSettled:!0})}dispose(){}}const _e="_container_p2v15_1",Ae="_card_p2v15_23",Re="_body_p2v15_23",Me="_secondary_p2v15_32",g={container:_e,card:Ae,body:Re,secondary:Me},{RangePicker:R}=he,De=r=>`$${r.toFixed(2)}`,M=r=>s.jsxs(s.Fragment,{children:[s.jsx(T,{value:r,dateStyle:"short"}),s.jsx("br",{}),s.jsx("span",{className:g.secondary,children:s.jsx(T,{value:r,timeStyle:"short"})})]}),D=r=>r||"—",ke=z(function({formModel:o}){const e=je(),t=ce.useBreakpoint(),[l,c]=n.useState(!1),{t:a}=O("admin"),h=n.useMemo(()=>[{label:a("payouts.status.pending"),value:d.Pending},{label:a("payouts.status.approved"),value:d.Approved},{label:a("payouts.status.rejected"),value:d.Rejected}],[a]),S=n.useMemo(()=>({[d.Pending]:{color:"orange",labelKey:"payouts.status.pending"},[d.Approved]:{color:"blue",labelKey:"payouts.status.approved"},[d.Rejected]:{color:"red",labelKey:"payouts.status.rejected"}}),[]),j=n.useCallback(i=>{const m=S[i];return m?s.jsx(_,{color:m.color,children:a(m.labelKey)}):s.jsx(_,{children:i})},[S,a]),b=n.useCallback(i=>{i?.[0]&&i[1]?(e.setDateFromFilter(i[0].toISOString()),e.setDateToFilter(i[1].toISOString())):(e.setDateFromFilter(void 0),e.setDateToFilter(void 0))},[e]),f=n.useCallback(i=>{e.setWebmasterIdFilter(i||void 0)},[e]),x=n.useCallback(i=>{e.setStatusFilter(i)},[e]),Y=n.useCallback(()=>{c(i=>!i)},[]),E=n.useCallback(()=>{c(!1)},[]),L=n.useMemo(()=>[{title:a("payouts.table.webmaster"),key:"webmaster",width:t.lg?128:t.md?100:t.sm?80:60,render:pe(i=>{const{webmaster:m,payout:F}=i;return s.jsxs("div",{children:[s.jsx(te,{to:"/admin/users",search:{id:F.webmasterId},children:m.email}),m.name&&s.jsx("div",{className:g.secondary,children:m.name})]})})},{title:a("payouts.table.amount"),dataIndex:["payout","amount"],key:"amount",width:t.lg?100:t.md?80:70,render:De},{title:a("payouts.table.status"),dataIndex:["payout","status"],key:"status",width:t.lg?100:t.md?80:70,render:j},{title:a("payouts.table.createdAt"),dataIndex:["payout","createdAt"],key:"createdAt",width:t.xl?120:t.lg?90:80,render:M,responsive:["lg"]},{title:a("payouts.table.updatedAt"),dataIndex:["payout","updatedAt"],key:"updatedAt",width:t.xl?120:t.lg?90:80,render:M,responsive:["xl"]},{title:a("payouts.table.comment"),dataIndex:["payout","comment"],key:"comment",width:t.xl?150:t.lg?110:90,ellipsis:!0,render:D,responsive:["lg"]},{title:a("payouts.table.managerComment"),dataIndex:["payout","managerComment"],key:"managerComment",width:t.xl?150:t.lg?110:90,ellipsis:!0,render:D,responsive:["xl"]},{title:a("payouts.table.actions"),key:"actions",width:60,fixed:t.lg?"right":void 0,render:(i,{payout:m})=>{const F={items:[{key:"approve",label:a("payouts.actions.approve"),disabled:m.status!==d.Pending,onClick:()=>{o.openModal(m.id,d.Approved)}},{key:"reject",label:a("payouts.actions.reject"),danger:!0,disabled:m.status!==d.Pending,onClick:()=>{o.openModal(m.id,d.Rejected)}}]};return s.jsx(ye,{menu:F,trigger:["click"],children:s.jsx(y,{type:"text",icon:s.jsx(be,{})})})}}],[o,t.sm,t.md,t.lg,t.xl,j,a]),W=n.useMemo(()=>s.jsxs(A,{direction:"vertical",style:{width:"100%"},size:"middle",children:[s.jsx(v.Search,{placeholder:a("payouts.filters.webmasterIdPlaceholder"),allowClear:!0,style:{width:"100%"},onSearch:f,size:t.xs?"large":"middle"}),s.jsx(w,{placeholder:a("payouts.filters.allStatuses"),allowClear:!0,style:{width:"100%"},value:e.statusFilter,onChange:x,options:h,size:t.xs?"large":"middle"}),s.jsx(R,{format:"DD.MM.YYYY",onChange:b,placeholder:[a("payouts.filters.dateFrom"),a("payouts.filters.dateTo")],style:{width:"100%"},size:t.xs?"large":"middle"}),s.jsx(y,{onClick:e.clearFilters,style:{width:"100%"},size:t.xs?"large":"middle",children:a("payouts.filters.resetFilters")})]}),[e.statusFilter,e.clearFilters,f,x,b,t.xs,h,a]),$=n.useMemo(()=>s.jsxs(A,{wrap:!0,children:[s.jsx(v.Search,{placeholder:a("payouts.filters.webmasterIdPlaceholder"),allowClear:!0,style:{width:200},onSearch:f}),s.jsx(w,{placeholder:a("payouts.filters.allStatuses"),allowClear:!0,style:{width:150},value:e.statusFilter,onChange:x,options:h}),s.jsx(R,{format:"DD.MM.YYYY",onChange:b,placeholder:[a("payouts.filters.dateFrom"),a("payouts.filters.dateTo")]}),s.jsx(y,{onClick:e.clearFilters,children:a("payouts.filters.resetFilters")})]}),[e.statusFilter,e.clearFilters,f,x,b,h,a]),K=n.useMemo(()=>t.xs?"100%":320,[t.xs]),P=e.payoutsQuery.data?.items||[],U=e.payoutsQuery.isPending||e.payoutsQuery.isFetching,B=n.useMemo(()=>t.xs||t.sm||t.md?"small":"middle",[t.xs,t.sm,t.md]),V=n.useMemo(()=>t.xs?a("payouts.titleShort"):a("payouts.title"),[t.xs,a]);return s.jsxs(s.Fragment,{children:[s.jsx(fe,{className:g.card,classNames:{body:g.body},title:V,extra:t.lg?$:s.jsx(y,{icon:s.jsx(re,{}),onClick:Y,children:a("payouts.filters.title")}),children:s.jsx(ge,{size:B,columns:L,dataSource:P,loading:U,rowKey:i=>i.payout.id,pagination:{current:e.page+1,pageSize:e.pageSize,total:P.length>0?void 0:0,onChange:i=>e.setPage(i-1),showSizeChanger:!1,responsive:!0,simple:t.xs,showTotal:t.md?i=>a("payouts.pagination.total",{count:i}):void 0},scroll:{x:"auto"}})}),s.jsx(xe,{title:a("payouts.filters.title"),placement:"right",open:l,onClose:E,width:K,styles:{body:{padding:t.xs?"16px":"24px"}},children:W})]})}),N=z(function(){const o=se(),{t:e}=O("admin"),t=I(()=>new Se(o),[o]),l=I(()=>new Te(o,()=>{t.payoutsQuery.refetch()}),[o,t]);return s.jsx(q.Provider,{value:t,children:s.jsxs(ae,{className:g.container,children:[s.jsx(ke,{formModel:l}),s.jsx(Fe,{title:e("payouts.modal.title"),open:l.modalToggler.isEnabled,onCancel:l.modalToggler.disable,maskClosable:!1,afterOpenChange:l.handleAfterOpenChange,footer:s.jsxs(Ce,{gap:"small",justify:"flex-end",children:[s.jsx(y,{onClick:l.modalToggler.disable,children:e("buttons.cancel",{ns:"common"})}),s.jsx(y,{type:"primary",loading:l.updateMutation.isPending,onClick:l.handleSubmit,disabled:!l.group.isChanged,children:e("buttons.save",{ns:"common"})})]}),centered:!0,children:s.jsxs(C,{layout:"vertical",onFinish:l.handleSubmit,children:[s.jsx(C.Item,{label:e("payouts.modal.statusLabel"),...l.status.itemProps,children:s.jsx(w,{placeholder:e("payouts.modal.statusPlaceholder"),...l.status.inputProps,disabled:!0})}),s.jsx(C.Item,{label:e("payouts.modal.managerCommentLabel"),...l.managerComment.itemProps,children:s.jsx(v.TextArea,{placeholder:e("payouts.modal.managerCommentPlaceholder"),rows:4,...l.managerComment.inputProps})})]})})]})})}),ze=Object.freeze(Object.defineProperty({__proto__:null,AdminPayouts:N},Symbol.toStringTag,{value:"Module"})),pt=N;export{pt as component};
