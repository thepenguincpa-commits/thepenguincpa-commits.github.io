import{l as V,_ as G,a as J,r as n,t as k,S as H,a2 as d,a0 as X,a3 as Z,o as z,j as s,a4 as ee,u as te,a1 as I}from"./index.CJpzWARr.js";import{u as O}from"./useTranslation.D1-YSIqG.js";import"./AppLayout.Dd4AyXhP.js";import{L as se}from"./LayoutContainer.kUniMi3O.js";import{P as ae,a as Q,R as re}from"./adminPayoutsApi.D8BE7S05.js";import{U as oe}from"./usersApi.CVFrqcan.js";import{T as ie}from"./Toggler.Bo1KxCe6.js";import{r as le,I as ne,a as ue,b as C}from"./validators.puhu6pph.js";import{S as de}from"./SelectControl.BdHLXDxG.js";import{r as me}from"./renderReactiveCell.D7yC0G9H.js";import{D as T}from"./DateFormat.CyIrXEyF.js";import{G as pe,D as ce}from"./index.BiYHNWbr.js";import{T as _}from"./index.mfBRClzR.js";import{D as he,S as M,F as ye}from"./Table.CnZn0sov.js";import{B as y}from"./button.CTAkPJpI.js";import{R as ge}from"./MoreOutlined.CYRW4zmn.js";import{I as v}from"./index.UwxdIMsP.js";import{S as w}from"./index.C7EzEdlH.js";import{C as be}from"./Input.BJc5rBil.js";import{D as fe}from"./index.DLP9cbOY.js";import{M as xe}from"./index.CnCisG79.js";import{F as Fe}from"./index.D5519FJg.js";import"./index.5jmBMbM4.js";import"./AntdIcon.BEv94oZ9.js";import"./row.ZVKcDUTg.js";import"./useClosable.Emosx8Km.js";import"./index.B7lSVg36.js";import"./EyeOutlined.C4wc5N2Y.js";import"./ActionButton.D2hXE_0n.js";import"./index.CvuYUNlW.js";const Ce=V(()=>Promise.all([G(()=>Promise.resolve().then(()=>Oe),void 0),J(["manager","common"])]).then(o=>({default:o[0].ManagerPayouts})));var ve=Object.defineProperty,we=(o,r,e)=>r in o?ve(o,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[r]=e,u=(o,r,e)=>we(o,typeof r!="symbol"?r+"":r,e);class Se{constructor(r){u(this,"payoutsQuery"),u(this,"payoutRequestRepository"),u(this,"userRepository"),u(this,"page",0),u(this,"pageSize",20),u(this,"statusFilter"),u(this,"webmasterIdFilter"),u(this,"dateFromFilter"),u(this,"dateToFilter"),u(this,"setPage",e=>{this.page=e,this.payoutsQuery.refetch()}),u(this,"setStatusFilter",e=>{this.statusFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"setWebmasterIdFilter",e=>{this.webmasterIdFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"setDateFromFilter",e=>{this.dateFromFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"setDateToFilter",e=>{this.dateToFilter=e,this.page=0,this.payoutsQuery.refetch()}),u(this,"clearFilters",()=>{this.statusFilter=void 0,this.webmasterIdFilter=void 0,this.dateFromFilter=void 0,this.dateToFilter=void 0,this.page=0,this.payoutsQuery.refetch()}),k(this,{},{autoBind:!0}),this.userRepository=r.repositories.get(oe),this.payoutRequestRepository=r.repositories.get(ae,this.userRepository),this.payoutsQuery=new H(r.queryClient,{queryKey:["manager","payouts",this.page,this.statusFilter,this.webmasterIdFilter,this.dateFromFilter,this.dateToFilter],queryFn:()=>Q.getAllPayouts({offset:this.page*this.pageSize,limit:this.pageSize,status:this.statusFilter,webmasterId:this.webmasterIdFilter,dateFrom:this.dateFromFilter,dateTo:this.dateToFilter}),transform:e=>e?{items:e.items.map(l=>{const c=this.payoutRequestRepository.get(l.id);c.updateFromJson(l);const a=this.userRepository.get(c.webmasterId).updateFromJson(e.users.find(h=>h.id===c.webmasterId)||{name:"Вебмастер",email:"dzhaweb@mail.com"});return{payout:c,webmaster:a}})}:{items:[]},staleTime:1e3*30})}dispose(){}init(){}}const q=n.createContext(null);function je(){const o=n.useContext(q);if(!o)throw new Error("Необходимо зарегистрировать провайдер ManagerPayoutsModelContext");return o}var Pe=Object.defineProperty,Ie=(o,r,e)=>r in o?Pe(o,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[r]=e,p=(o,r,e)=>Ie(o,typeof r!="symbol"?r+"":r,e);class Te{constructor(r,e){this.onSuccess=e,p(this,"modalToggler",new ie(!1)),p(this,"updateMutation"),p(this,"payoutId",null),p(this,"status",new de("pending",{validators:[le(()=>"Выберите статус")],options:()=>[{label:"Ожидает",value:d.Pending},{label:"Одобрено",value:d.Approved},{label:"Отклонено",value:d.Rejected}]})),p(this,"managerComment",new ne("",{validators:[]})),p(this,"group",new ue({status:this.status,managerComment:this.managerComment})),p(this,"openModal",(t,l)=>{this.payoutId=t,this.status.setValue(l),this.modalToggler.enable()}),p(this,"handleAfterOpenChange",t=>{t||(this.group.reset(),this.payoutId=null)}),p(this,"handleSubmit",async()=>{if(this.group.isInvalid){this.group.setTouched(!0),this.group.setDirty(!0),this.group.firstErrorControl?.element?.focus();return}this.payoutId&&await this.updateMutation.mutate({payoutId:this.payoutId,status:this.status.value,managerComment:this.managerComment.value||void 0})}),k(this,{},{autoBind:!0}),this.updateMutation=new X(r.queryClient,{mutationFn:async t=>Q.updatePayoutRequest({payoutId:t.payoutId,payoutRequestUpdateDto:{status:t.status,managerComment:t.managerComment}}),onSuccess:()=>{Z(()=>{this.modalToggler.disable(),this.group.reset(),this.onSuccess()})},resetOnSettled:!0})}dispose(){}}const _e="_container_p2v15_1",Me="_card_p2v15_23",Re="_body_p2v15_23",Ae="_secondary_p2v15_32",g={container:_e,card:Me,body:Re,secondary:Ae},{RangePicker:R}=ce,De=o=>`$${o.toFixed(2)}`,A=o=>s.jsxs(s.Fragment,{children:[s.jsx(T,{value:o,dateStyle:"short"}),s.jsx("br",{}),s.jsx("span",{className:g.secondary,children:s.jsx(T,{value:o,timeStyle:"short"})})]}),D=o=>o||"—",ke=z(function({formModel:r}){const e=je(),t=pe.useBreakpoint(),[l,c]=n.useState(!1),{t:a}=O("manager"),h=n.useMemo(()=>[{label:a("payouts.status.pending"),value:d.Pending},{label:a("payouts.status.approved"),value:d.Approved},{label:a("payouts.status.rejected"),value:d.Rejected}],[a]),S=n.useMemo(()=>({[d.Pending]:{color:"orange",labelKey:"payouts.status.pending"},[d.Approved]:{color:"blue",labelKey:"payouts.status.approved"},[d.Rejected]:{color:"red",labelKey:"payouts.status.rejected"}}),[]),j=n.useCallback(i=>{const m=S[i];return m?s.jsx(_,{color:m.color,children:a(m.labelKey)}):s.jsx(_,{children:i})},[S,a]),b=n.useCallback(i=>{i?.[0]&&i[1]?(e.setDateFromFilter(i[0].toISOString()),e.setDateToFilter(i[1].toISOString())):(e.setDateFromFilter(void 0),e.setDateToFilter(void 0))},[e]),f=n.useCallback(i=>{e.setWebmasterIdFilter(i||void 0)},[e]),x=n.useCallback(i=>{e.setStatusFilter(i)},[e]),N=n.useCallback(()=>{c(i=>!i)},[]),L=n.useCallback(()=>{c(!1)},[]),Y=n.useMemo(()=>[{title:a("payouts.table.webmaster"),key:"webmaster",width:t.lg?128:t.md?100:t.sm?80:60,render:me(i=>{const{webmaster:m,payout:F}=i;return s.jsxs("div",{children:[s.jsx(ee,{to:"/manager/users",search:{id:F.webmasterId},children:m.email}),m.name&&s.jsx("div",{className:g.secondary,children:m.name})]})})},{title:a("payouts.table.amount"),dataIndex:["payout","amount"],key:"amount",width:t.lg?100:t.md?80:70,render:De},{title:a("payouts.table.status"),dataIndex:["payout","status"],key:"status",width:t.lg?100:t.md?80:70,render:j},{title:a("payouts.table.createdAt"),dataIndex:["payout","createdAt"],key:"createdAt",width:t.xl?120:t.lg?90:80,render:A,responsive:["lg"]},{title:a("payouts.table.updatedAt"),dataIndex:["payout","updatedAt"],key:"updatedAt",width:t.xl?120:t.lg?90:80,render:A,responsive:["xl"]},{title:a("payouts.table.comment"),dataIndex:["payout","comment"],key:"comment",width:t.xl?150:t.lg?110:90,ellipsis:!0,render:D,responsive:["lg"]},{title:a("payouts.table.managerComment"),dataIndex:["payout","managerComment"],key:"managerComment",width:t.xl?150:t.lg?110:90,ellipsis:!0,render:D,responsive:["xl"]},{title:a("payouts.table.actions"),key:"actions",width:60,fixed:t.lg?"right":void 0,render:(i,{payout:m})=>{const F={items:[{key:"approve",label:a("payouts.actions.approve"),disabled:m.status!==d.Pending,onClick:()=>{r.openModal(m.id,d.Approved)}},{key:"reject",label:a("payouts.actions.reject"),danger:!0,disabled:m.status!==d.Pending,onClick:()=>{r.openModal(m.id,d.Rejected)}}]};return s.jsx(he,{menu:F,trigger:["click"],children:s.jsx(y,{type:"text",icon:s.jsx(ge,{})})})}}],[r,t.sm,t.md,t.lg,t.xl,j,a]),E=n.useMemo(()=>s.jsxs(M,{direction:"vertical",style:{width:"100%"},size:"middle",children:[s.jsx(v.Search,{placeholder:a("payouts.filters.webmasterIdPlaceholder"),allowClear:!0,style:{width:"100%"},onSearch:f,size:t.xs?"large":"middle"}),s.jsx(w,{placeholder:a("payouts.filters.allStatuses"),allowClear:!0,style:{width:"100%"},value:e.statusFilter,onChange:x,options:h,size:t.xs?"large":"middle"}),s.jsx(R,{format:"DD.MM.YYYY",onChange:b,placeholder:[a("payouts.filters.dateFrom"),a("payouts.filters.dateTo")],style:{width:"100%"},size:t.xs?"large":"middle"}),s.jsx(y,{onClick:e.clearFilters,style:{width:"100%"},size:t.xs?"large":"middle",children:a("payouts.filters.resetFilters")})]}),[e.statusFilter,e.clearFilters,f,x,b,t.xs,h,a]),W=n.useMemo(()=>s.jsxs(M,{wrap:!0,children:[s.jsx(v.Search,{placeholder:a("payouts.filters.webmasterIdPlaceholder"),allowClear:!0,style:{width:200},onSearch:f}),s.jsx(w,{placeholder:a("payouts.filters.allStatuses"),allowClear:!0,style:{width:150},value:e.statusFilter,onChange:x,options:h}),s.jsx(R,{format:"DD.MM.YYYY",onChange:b,placeholder:[a("payouts.filters.dateFrom"),a("payouts.filters.dateTo")]}),s.jsx(y,{onClick:e.clearFilters,children:a("payouts.filters.resetFilters")})]}),[e.statusFilter,e.clearFilters,f,x,b,h,a]),$=n.useMemo(()=>t.xs?"100%":320,[t.xs]),P=e.payoutsQuery.data?.items||[],K=e.payoutsQuery.isPending||e.payoutsQuery.isFetching,U=n.useMemo(()=>t.xs||t.sm||t.md?"small":"middle",[t.xs,t.sm,t.md]),B=n.useMemo(()=>t.xs?a("payouts.titleShort"):a("payouts.title"),[t.xs,a]);return s.jsxs(s.Fragment,{children:[s.jsx(be,{className:g.card,classNames:{body:g.body},title:B,extra:t.lg?W:s.jsx(y,{icon:s.jsx(re,{}),onClick:N,children:a("payouts.filters.title")}),children:s.jsx(ye,{size:U,columns:Y,dataSource:P,loading:K,rowKey:i=>i.payout.id,pagination:{current:e.page+1,pageSize:e.pageSize,total:P.length>0?void 0:0,onChange:i=>e.setPage(i-1),showSizeChanger:!1,responsive:!0,simple:t.xs,showTotal:t.md?i=>a("payouts.pagination.total",{count:i}):void 0},scroll:{x:"auto"}})}),s.jsx(fe,{title:a("payouts.filters.title"),placement:"right",open:l,onClose:L,width:$,styles:{body:{padding:t.xs?"16px":"24px"}},children:E})]})}),ze=z(function(){const r=te(),{t:e}=O("manager"),t=I(()=>new Se(r),[r]),l=I(()=>new Te(r,()=>{t.payoutsQuery.refetch()}),[r,t]);return s.jsx(q.Provider,{value:t,children:s.jsxs(se,{className:g.container,children:[s.jsx(ke,{formModel:l}),s.jsx(xe,{title:e("payouts.modal.title"),open:l.modalToggler.isEnabled,onCancel:l.modalToggler.disable,maskClosable:!1,afterOpenChange:l.handleAfterOpenChange,footer:s.jsxs(Fe,{gap:"small",justify:"flex-end",children:[s.jsx(y,{onClick:l.modalToggler.disable,children:e("buttons.cancel",{ns:"common"})}),s.jsx(y,{type:"primary",loading:l.updateMutation.isPending,onClick:l.handleSubmit,disabled:!l.group.isChanged,children:e("buttons.save",{ns:"common"})})]}),centered:!0,children:s.jsxs(C,{layout:"vertical",onFinish:l.handleSubmit,children:[s.jsx(C.Item,{label:e("payouts.modal.statusLabel"),...l.status.itemProps,children:s.jsx(w,{placeholder:e("payouts.modal.statusPlaceholder"),...l.status.inputProps,disabled:!0})}),s.jsx(C.Item,{label:e("payouts.modal.managerCommentLabel"),...l.managerComment.itemProps,children:s.jsx(v.TextArea,{placeholder:e("payouts.modal.managerCommentPlaceholder"),rows:4,...l.managerComment.inputProps})})]})})]})})}),Oe=Object.freeze(Object.defineProperty({__proto__:null,ManagerPayouts:ze},Symbol.toStringTag,{value:"Module"})),ct=Ce;export{ct as component};
