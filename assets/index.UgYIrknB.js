import{M as _,w as Z,x as y,y as O,z as ee,k as P,n as te,A as c,o as v,j as r,r as x,L as K,u as re,q as se}from"./index.B-zO2jcy.js";import{L as ie}from"./LayoutContainer.DB_i7kpz.js";import{o as j,O as ae,a as oe,b as ne,c as le,d as J,e as ce,C as ue}from"./CountryName.BQMzn-nx.js";import{R as U}from"./Registry.B8N-PobL.js";import{I as de}from"./InfiniteQueryWithState.BB8vim5Z.js";import{O as me,B as D}from"./Box.MGoU-yNc.js";import{O as he,R as fe}from"./OfferFormModel.DzWhnTBG.js";import{T as M}from"./Toggler.CKVCiuUU.js";import{I as N,r as $,F as pe,a as d}from"./validators.CuBSd0d9.js";import{u as G,a as q,P as ge}from"./useTranslation.B4Aad4mp.js";import{F as W,r as m,D as ye}from"./renderReactiveCell.HbM7Emo9.js";import{I as w}from"./index.CmXbVTZH.js";import{M as z}from"./index.BJKN9cGs.js";import{B as h}from"./button.BPmN1wK-.js";import{P as H,R as be}from"./SyncOutlined.BmjTHdYE.js";import{R as xe}from"./DeleteOutlined.1THMemLK.js";import{G as je}from"./GridRow.Cw_MRkgE.js";import{C as k}from"./row.ClGDsWbn.js";import{C as A}from"./index.BcPC7EJu.js";import{F as V}from"./index.BQ2Co5HI.js";import{O as Pe}from"./OfferCategoryName.CdVa3hvL.js";import{D as I}from"./DateFormat.DYZc4s3P.js";import{u as X}from"./useTranslation.JeF3lAzJ.js";import{T}from"./index.CGcGwI_R.js";import{T as ve}from"./AntdIcon.BzrxpPa1.js";import{C as Ce,T as Oe}from"./EyeOutlined.DZce5g_D.js";import{D as we}from"./index.BJBaYR0i.js";import"./usersApi.BNtDjJ_q.js";import"./CheckboxControl.BbUgZ61z.js";import"./SelectControl.BGsAxn8z.js";import"./index.BmkQiUau.js";import"./index.CspahUgb.js";var _e=Object.defineProperty,Fe=(i,e,t)=>e in i?_e(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,B=(i,e,t)=>Fe(i,typeof e!="symbol"?e+"":e,t);class Ie{constructor(e,t,s,o){this.appContext=e,this.categoriesQuery=t,this.currentItem=s,B(this,"mutation"),B(this,"data"),this.data=this.parseData(s),this.mutation=new _(this.appContext.queryClient,{mutationFn:async n=>j.patchOffersId({offerId:s.id,...n}),onSuccess:n=>{this.updateFromJson(n),o.onUpdate(n)}}),Z(this,{data:ee.ref,offer:y,category:y,locations:y({equals:O.shallow}),basePayouts:y({equals:O.shallow}),personalPayouts:y({equals:O.shallow}),domains:y({equals:O.shallow}),repositories:y({equals:O.shallow})})}get id(){return this.offer.id}parseData({locations:e,basePayouts:t,personalPayouts:s,domains:o,...n}){const a=this.appContext.repositories.get(ae),u=this.appContext.repositories.get(oe),g=this.appContext.repositories.get(ne),C=this.appContext.repositories.get(le),F=this.appContext.repositories.get(me);return{offer:a.get(n.id).updateFromJson({...n,locations:e.map(l=>l.id),basePayouts:t.map(l=>l.id),personalPayouts:s.map(l=>l.id),domains:o.map(l=>l.id)}),locations:e.map(l=>u.get(l.id).updateFromJson(l)),basePayouts:t.map(l=>g.get(l.id).updateFromJson(l)),personalPayouts:s.map(l=>C.get(l.id).updateFromJson(l)),domains:o.map(l=>F.get(l.id).updateFromJson(l)),offerRepository:a,locationRepository:u,personalPayoutRepository:C,basePayoutRepository:g,domainRepository:F}}get repositories(){return{offer:this.data.offerRepository,locations:this.data.locationRepository,domains:this.data.domainRepository,personalPayouts:this.data.personalPayoutRepository,basePayouts:this.data.basePayoutRepository,categories:this.categoriesQuery.repository}}updateFromJson(e){e!==this.currentItem&&(this.data=this.parseData(e))}get offer(){return this.data.offer}get category(){return this.categoriesQuery.repository.get(this.offer.category)}get locations(){return this.data.locations}get basePayouts(){return this.data.basePayouts}get personalPayouts(){return this.data.personalPayouts}get domains(){return this.data.domains}}var Te=Object.defineProperty,Re=(i,e,t)=>e in i?Te(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,R=(i,e,t)=>Re(i,typeof e!="symbol"?e+"":e,t);class E{constructor(e,t){this.status=t,R(this,"query"),R(this,"categoriesQuery"),R(this,"limit",10),R(this,"offset",0),this.categoriesQuery=new J(e);const s=new WeakMap;this.query=new de(e.queryClient,{queryKey:this.getQueryKey(),queryFn:()=>j.getOffers({status:this.status,offset:0,limit:20}),getNextPageParam:(o,n)=>{const a=n.reduce((u,g)=>u+g.items.length,0);if(!(a>=o.total))return a},initialPageParam:0,transform:({pages:o}={pageParams:[],pages:[]})=>({data:o.flatMap(a=>{let u=s.get(a);return u||(u=new U(g=>new Ie(e,this.categoriesQuery,g,{onUpdate:()=>{this.query.invalidate()}}))),u.from(a.items)}),total:(o[o.length-1]||{total:0}).total}),staleTime:1e3*60*5,refetchOnWindowFocus:!0,onError:o=>{e.notify.toastError(o)},placeholderData:o=>o}),P(this,{},{autoBind:!0})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}refresh(){this.query.refetch()}getQueryKey(){return["admin-offers",this.status,this.limit,this.offset]}handlePagination(e,t){this.limit=t,this.offset=(e-1)*t,this.query.updateOptions({queryKey:this.getQueryKey()})}}var qe=Object.defineProperty,Ae=(i,e,t)=>e in i?qe(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,S=(i,e,t)=>Ae(i,typeof e!="symbol"?e+"":e,t);class Ee{constructor(e,t){this.appConfig=e,S(this,"mutation"),S(this,"form"),S(this,"modalToggler",new M(!1)),P(this,{handleSubmit:te.bound},{autoBind:!0}),this.form=new he(this.appConfig,()=>null),this.mutation=new _(e.queryClient,{mutationFn:async s=>j.postOffers(s),onSuccess:s=>{this.modalToggler.disable(),t(s)},onError:s=>{this.appConfig.notify.toastError(s)}})}handleAfterOpenChange(e){e||this.form.group.reset()}handleSubmit(){const e=this.form.group.value;if(this.form.group.isInvalid||e.image===null){this.form.group.setTouched(!0),this.form.group.setDirty(!0),this.form.group.firstErrorControl?.element?.focus();return}this.mutation.mutate({...e,image:e.image})}}var Se=Object.defineProperty,Le=(i,e,t)=>e in i?Se(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,L=(i,e,t)=>Le(i,typeof e!="symbol"?e+"":e,t);class Y{constructor(e,t){this.appContext=e,this.initialDataGetter=t,L(this,"nameEn",new N(()=>this.initialData.nameEn,{validators:[$(()=>this.t.forms("required"))]})),L(this,"nameRu",new N(()=>this.initialData.nameRu,{validators:[$(()=>this.t.forms("required"))]})),L(this,"group",new pe({nameEn:this.nameEn,nameRu:this.nameRu})),P(this,{},{autoBind:!0})}get t(){return this.appContext.locale.translations}get initialData(){return this.initialDataGetter()||new ce("")}}var Me=Object.defineProperty,De=(i,e,t)=>e in i?Me(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,f=(i,e,t)=>De(i,typeof e!="symbol"?e+"":e,t);class Ne{constructor(e){f(this,"query"),f(this,"mutation"),f(this,"form"),f(this,"registry"),f(this,"isOpenToggler",new M(!1)),f(this,"selectedItem",""),f(this,"modalFormToggler",new M(!1)),this.registry=new U(t=>new $e(e,t,{onDelete:async()=>{await this.query.refetch()},onUpdate:async()=>{await this.query.refetch(),this.modalFormToggler.disable()}})),this.form=new Y(e,()=>null),this.query=new J(e),this.mutation=new _(e.queryClient,{mutationFn:async()=>{const t=await j.postOfferCategories({offerCategoryCreateDto:this.form.group.value});return await this.query.refetch(),this.modalFormToggler.disable(),t},onError:t=>{e.notify.toastError(t)}}),P(this,{},{autoBind:!0})}setSelectedItem(e){this.selectedItem=e,this.modalFormToggler.enable()}get selectedItemModel(){return this.categories.find(e=>e.category.id===this.selectedItem)}get categories(){return this.registry.from(this.query.data.items)}handleAfterOpenChange(e){e||(this.selectedItem="",this.form.group.reset())}handleSubmit(){if(this.form.group.isInvalid){this.form.group.setTouched(!0),this.form.group.setDirty(!0),this.form.group.firstErrorControl?.element?.focus();return}return this.mutation.mutate()}}class $e{constructor(e,t,s){this.appContext=e,this.category=t,this.props=s,f(this,"deleteMutation"),f(this,"mutation"),f(this,"form"),this.form=new Y(e,()=>t),this.mutation=new _(e.queryClient,{mutationFn:async()=>{await j.patchOfferCategories({categoryId:t.id,offerCategoryUpdateDto:this.form.group.value}),await s.onUpdate()},onError:o=>{e.notify.toastError(o)}}),this.deleteMutation=new _(e.queryClient,{mutationFn:async()=>{await j.deleteOfferCategories({categoryId:t.id}),await s.onDelete()},onError:o=>{e.notify.toastError(o)}}),P(this,{},{autoBind:!0})}get id(){return this.category.id}async handleSubmit(){if(this.form.group.isInvalid){this.form.group.setTouched(!0),this.form.group.setDirty(!0),this.form.group.firstErrorControl?.element?.focus();return}return this.mutation.mutate()}async handleDelete(){return this.deleteMutation.mutate()}}var ke=Object.defineProperty,Be=(i,e,t)=>e in i?ke(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,b=(i,e,t)=>Be(i,typeof e!="symbol"?e+"":e,t);class Qe{constructor(e){b(this,"createModal"),b(this,"activeList"),b(this,"pausedList"),b(this,"archivedList"),b(this,"categoriesSettings"),b(this,"tab",c.Active),this.activeList=new E(e,c.Active),this.pausedList=new E(e,c.Paused),this.archivedList=new E(e,c.Archived),this.categoriesSettings=new Ne(e),this.createModal=new Ee(e,()=>{this.activeList.query.invalidate(),this.pausedList.query.invalidate(),this.archivedList.query.invalidate()}),P(this,{},{autoBind:!0})}setTab(e){this.tab=e}get offersList(){return this.tab===c.Paused?this.pausedList:this.tab===c.Archived?this.archivedList:this.activeList}handleAddOffer(){this.createModal.modalToggler.enable()}dispose(){console.log("dispose")}init(){console.log("init")}}const Ke="_card_hbmmy_1",Je="_body_hbmmy_1",Ue="_table_hbmmy_4",Ge="_pagination_hbmmy_13",We="_tags_hbmmy_19",ze="_secondary_hbmmy_25",p={card:Ke,body:Je,table:Ue,pagination:Ge,tags:We,secondary:ze},Q=v(function({form:e,handleSubmit:t}){return r.jsxs(d,{layout:"vertical",onFinish:t,children:[r.jsx(d.Item,{label:"Название (EN)",...e.nameEn.itemProps,children:r.jsx(w,{placeholder:"Введите название (EN)",...e.nameEn.inputProps})}),r.jsx(d.Item,{label:"Название (EN)",...e.nameRu.itemProps,children:r.jsx(w,{placeholder:"Введите название (EN)",...e.nameRu.inputProps})})]})}),He=v(function({model:e}){const{t}=G("offer"),s=e.categories,o=[{title:"Название (EN)",render:m(({category:n})=>n.nameRu)},{title:"Название (RU)",render:m(({category:n})=>n.nameRu)},{title:"Действия",render:m(n=>r.jsxs(D,{gap:"xs",children:[r.jsx(h,{icon:r.jsx(fe,{}),onClick:()=>e.setSelectedItem(n.id)}),r.jsx(H,{title:"Удалить категорию?",onConfirm:n.handleDelete,placement:"left",children:r.jsx(h,{danger:!0,icon:r.jsx(xe,{})})})]}))}];return r.jsxs(r.Fragment,{children:[r.jsx(W,{columns:o,dataSource:s,rowKey:"id",pagination:!1,sticky:!0}),r.jsx(z,{destroyOnHidden:!0,open:e.modalFormToggler.isEnabled,onCancel:e.modalFormToggler.disable,maskClosable:!1,afterOpenChange:e.handleAfterOpenChange,footer:r.jsxs(D,{gap:"sm",justify:"end",children:[r.jsx(h,{onClick:e.modalFormToggler.disable,children:t("buttons.cancel",{ns:"common"})}),e.selectedItemModel?r.jsx(h,{type:"primary",loading:e.selectedItemModel.mutation.isPending,onClick:e.selectedItemModel.handleSubmit,children:t("buttons.submit",{ns:"common"})}):r.jsx(h,{type:"primary",loading:e.mutation.isPending,onClick:e.handleSubmit,children:t("buttons.submit",{ns:"common"})})]}),centered:!0,children:e.selectedItemModel?r.jsx(Q,{form:e.selectedItemModel.form,handleSubmit:e.selectedItemModel.handleSubmit}):r.jsx(Q,{form:e.form,handleSubmit:e.handleSubmit})})]})}),Ve=v(function({model:e}){const{t}=G("offer"),s=e.form;return r.jsx(z,{title:t("form.formName"),destroyOnHidden:!0,open:e.modalToggler.isEnabled,onCancel:e.modalToggler.disable,maskClosable:!1,afterOpenChange:e.handleAfterOpenChange,footer:r.jsxs(V,{gap:"small",justify:"flex-end",children:[r.jsx(h,{onClick:e.modalToggler.disable,children:t("buttons.cancel",{ns:"common"})}),r.jsx(h,{type:"primary",loading:e.mutation.isPending,onClick:e.handleSubmit,disabled:!s.group.isChanged,children:t("buttons.submit",{ns:"common"})})]}),width:800,centered:!0,children:r.jsx(d,{layout:"vertical",onFinish:e.handleSubmit,children:r.jsxs(je,{children:[r.jsxs(k,{xs:24,md:12,children:[r.jsx(d.Item,{label:t("form.titleLabel"),...s.title.itemProps,children:r.jsx(w,{placeholder:t("form.titlePlaceholder"),...s.title.inputProps})}),r.jsx(d.Item,{label:t("form.subtitleLabel"),...s.subtitle.itemProps,children:r.jsx(w,{placeholder:t("form.subtitlePlaceholder"),...s.subtitle.inputProps})}),r.jsx(d.Item,{label:t("form.rulesLabel"),...s.rules.itemProps,children:r.jsx(w.TextArea,{placeholder:t("form.rulesPlaceholder"),...s.rules.inputProps,rows:9})})]}),r.jsxs(k,{xs:24,md:12,children:[r.jsx(d.Item,{label:t("form.verticalLabel"),...s.vertical.itemProps,children:r.jsx(q,{placeholder:t("form.verticalPlaceholder"),optionFilterProp:"label",showSearch:!0,...s.vertical.inputProps})}),r.jsx(d.Item,{label:t("form.categoryLabel"),...s.category.itemProps,children:r.jsx(q,{placeholder:t("form.categoryPlaceholder"),...s.category.inputProps})}),r.jsx(d.Item,{label:t("form.statusLabel"),...s.status.itemProps,children:r.jsx(q,{placeholder:t("form.statusPlaceholder"),...s.status.inputProps})}),r.jsx(d.Item,{...s.accessOnRequest.itemProps,children:r.jsx(A,{...s.accessOnRequest.inputProps,children:t("form.accessOnRequestLabel")})}),r.jsx(d.Item,{...s.isTest.itemProps,children:r.jsx(A,{...s.isTest.inputProps,children:t("form.isTestLabel")})}),r.jsx(d.Item,{...s.isExclusive.itemProps,children:r.jsx(A,{...s.isExclusive.inputProps,children:t("form.isExclusiveLabel")})})]})]})})})}),Xe=x.memo(function({name:e,onConfirm:t}){const s=x.useRef(null),o=x.useRef(!1);return r.jsx(H,{ref:s,title:`${e}?`,onConfirm:n=>(n?.stopPropagation(),t().then(()=>{o.current=!0,s.current?.popupElement.click()}).catch(()=>{o.current=!1})),onPopupClick:n=>{o.current?o.current=!1:n?.stopPropagation()},onCancel:n=>n?.stopPropagation(),placement:"left",children:r.jsx("div",{onClick:n=>n.stopPropagation(),children:e})})}),Ye=v(function({item:e}){const{offer:t,mutation:s}=e,{t:o}=X("offer"),n=x.useMemo(()=>({active:o("actions.activate"),paused:o("actions.pause"),archived:o("actions.archive")}),[o]),a=x.useMemo(()=>{const u=C=>{const F=n[C];return r.jsx(Xe,{onConfirm:()=>s.mutateAsync({status:C}),name:F})};return{items:[{key:"edit",label:r.jsx(K,{to:"/admin/offers/$offerId",params:{offerId:t.id},children:o("actions.edit")})},t.status!==c.Active&&{key:c.Active,label:u(c.Active)},t.status!==c.Paused&&{key:c.Paused,label:u(c.Paused)},t.status!==c.Archived&&{key:"divider",type:"divider"},t.status!==c.Archived&&{key:c.Archived,label:u(c.Archived),danger:!0}].filter(Boolean)}},[t.status,t.id,s,n,o]);return r.jsx(V,{gap:"small",children:r.jsx(ye,{menu:a,trigger:["click"],children:r.jsx(h,{children:o("actions.detail")})})})}),Ze=v(function({page:e}){const{t}=X("offer"),s=e.offersList,o=x.useMemo(()=>[{key:"title",title:t("table.title"),render:m(({offer:a})=>r.jsx(K,{to:"/admin/offers/$offerId",params:{offerId:a.id},children:a.title}))},{key:"vertical",title:t("table.vertical"),render:m(({offer:a})=>t(`vertical.${a.vertical}`))},{key:"category",title:t("table.category"),render:m(({category:a})=>r.jsx(Pe,{category:a}))},{key:"tags",title:t("table.tags"),render:m(({offer:a})=>r.jsxs("div",{className:p.tags,children:[a.accessOnRequest&&r.jsx(T,{color:"error",children:t("status.accessOnRequest")}),a.isExclusive&&r.jsx(T,{color:"purple",children:t("status.isExclusive")}),a.isTopOffer&&r.jsx(T,{color:"blue",children:t("status.isTopOffer")}),a.isTest&&r.jsx(T,{color:"warning",children:t("status.isTest")})]}))},{key:"cr",title:t("table.cr"),render:m(({offer:a})=>a.cr)},{key:"approve",title:t("table.approve"),render:m(({offer:a})=>a.approve)},{key:"languages",title:t("table.languages"),render:m(({locations:a})=>r.jsx(ve,{overlay:r.jsx(r.Fragment,{children:a.map(u=>r.jsxs(r.Fragment,{children:[r.jsx(ue,{code:u.countryCode})," ",r.jsx("br",{})]}))}),children:r.jsx("div",{children:a.length})}))},{key:"createdAt",title:t("table.createdAt"),render:m(({offer:a})=>r.jsxs(r.Fragment,{children:[r.jsx(I,{value:a.createdAt,dateStyle:"short"}),r.jsx("br",{}),r.jsx("span",{className:p.secondary,children:r.jsx(I,{value:a.createdAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"updatedAt",title:t("table.updatedAt"),render:m(({offer:a})=>r.jsxs(r.Fragment,{children:[r.jsx(I,{value:a.updatedAt,dateStyle:"short"}),r.jsx("br",{}),r.jsx("span",{className:p.secondary,children:r.jsx(I,{value:a.updatedAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"actions",title:t("table.actions"),render:m(a=>r.jsx(Ye,{item:a})),fixed:"right"}].filter(Boolean),[t]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:p.table,children:r.jsx(W,{rowKey:"id",loading:!s.query.isFetched&&{size:"large"},columns:o,pagination:!1,dataSource:s.data})}),r.jsx("div",{className:p.pagination,children:r.jsx(ge,{current:s.currentPage,onChange:s.handlePagination,total:s.total,pageSize:s.limit})})]})}),et=v(function(){const e=re(),t=se(()=>new Qe(e),[e]),s=t.categoriesSettings;return r.jsxs(ie,{children:[r.jsx(Ve,{model:t.createModal}),r.jsx(Ce,{className:p.card,classNames:{body:p.body},title:r.jsx(Oe,{tabBarExtraContent:r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsx(h,{onClick:t.offersList.refresh,loading:t.offersList.query.isFetching,icon:r.jsx(be,{})}),r.jsx(h,{onClick:s.isOpenToggler.enable,children:"Настройки категорий"}),r.jsx(h,{type:"primary",onClick:t.handleAddOffer,children:"Добавить оффер"})]}),items:[{key:c.Active,label:"Активные"},{key:c.Paused,label:"На паузе"},{key:c.Archived,label:"Архив"}],accessKey:t.tab,onChange:t.setTab}),children:r.jsx(Ze,{page:t})}),r.jsx(we,{size:"large",className:p.card,classNames:{body:p.body},open:s.isOpenToggler.isEnabled,onClose:s.isOpenToggler.disable,extra:r.jsx(h,{type:"primary",onClick:s.modalFormToggler.enable,children:"Добавить категорию"}),children:r.jsx(He,{model:s})})]})}),Et=et;export{Et as component};
