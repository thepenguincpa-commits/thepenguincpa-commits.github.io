import{w as N,R as W,a as F}from"./webmasterStatsApi.CDa-A2Cm.js";import{t as C,o as L,r as u,f as Q,j as e,a4 as q,O as G,e as H,al as m,u as U,a1 as V}from"./index.WsYO2dy-.js";import{G as J,d as R,D as X}from"./index.CfoN1hn6.js";import{u as Z}from"./useTranslation.Bt2PYRL2.js";import{R as tt}from"./AppLayout.DyHuBULn.js";import{L as et}from"./LayoutContainer.CsWPLRk4.js";import{I as z}from"./InfiniteQueryWithState.DXgnPzYl.js";import{B as P}from"./Box.BoA2lbt8.js";import{C as $}from"./CountryName.CtqEwQTt.js";import{D}from"./DateFormat.DX8kRgXq.js";import{F as k}from"./FlagIcon.Canhu2ph.js";import{u as A}from"./useTranslation.D4fSpiLe.js";import{T as st}from"./index.D7q-MwFy.js";import{B as E}from"./button.B3PsbA3S.js";import{D as c}from"./index.CZ1OK7Vi.js";import{F as Y}from"./Table.Dku94qg-.js";import{P as B}from"./index.DGsLj2m-.js";import{T as y}from"./AntdIcon.vojNxC2w.js";import{R as K,a as M}from"./ClockCircleOutlined.BwMz-DBT.js";import{C as O,T as at}from"./Input.CS61qdQu.js";import{R as it}from"./SyncOutlined.BuXhQB6u.js";import{R as nt,C as x}from"./row.C2dg1pTq.js";import{S as g}from"./index.DNnqjxYK.js";import"./index.BAyObCzF.js";import"./useClosable.D4JC76of.js";import"./index.DLZ010Vy.js";var rt=Object.defineProperty,ot=(i,s,t)=>s in i?rt(i,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[s]=t,v=(i,s,t)=>ot(i,typeof s!="symbol"?s+"":s,t);const lt=()=>{const i=new Date;return i.setDate(i.getDate()-7),i.toISOString().split("T")[0]},dt=()=>new Date().toISOString().split("T")[0];class ct{constructor(s){v(this,"dateFrom",lt()),v(this,"dateTo",dt()),v(this,"offset",0),v(this,"limit",50),v(this,"query"),C(this,{query:!1,queryKey:!0},{autoBind:!0}),this.query=new z(s.queryClient,{queryKey:this.queryKey,queryFn:async()=>{const t={offset:this.offset,limit:this.limit};return this.dateFrom&&(t.from=this.dateFrom),this.dateTo&&(t.to=this.dateTo),N.getStatsByConversion(t)},getNextPageParam:()=>{},initialPageParam:0,transform:({pages:t}={pageParams:[],pages:[]})=>{const a=t[t.length-1];return{items:a?.items||[],total:a?.total||0}},onError:t=>{s.notify.toastError(t)},staleTime:1e3*60,enabled:!1,placeholderData:t=>t})}get queryKey(){return["webmaster","stats","conversions",this.dateFrom,this.dateTo,this.offset,this.limit]}setDateRange(s,t){this.dateFrom=s,this.dateTo=t,this.query.updateOptions({queryKey:this.queryKey})}handlePagination(s,t){this.offset=(s-1)*t,this.limit=t,this.query.updateOptions({queryKey:this.queryKey})}refresh(){this.query.refetch()}get items(){return this.query.data.items}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}enableQuery(){this.query.isFetched||(this.query.updateOptions({enabled:!0}),this.query.refetch())}}var ht=Object.defineProperty,ut=(i,s,t)=>s in i?ht(i,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[s]=t,b=(i,s,t)=>ut(i,typeof s!="symbol"?s+"":s,t);const mt=()=>{const i=new Date;return i.setDate(i.getDate()-7),i.toISOString().split("T")[0]},pt=()=>new Date().toISOString().split("T")[0];class yt{constructor(s){b(this,"dateFrom",mt()),b(this,"dateTo",pt()),b(this,"offset",0),b(this,"limit",20),b(this,"query"),C(this,{query:!1,queryKey:!0},{autoBind:!0}),this.query=new z(s.queryClient,{queryKey:this.queryKey,queryFn:async()=>{const t={};return this.dateFrom&&(t.from=this.dateFrom),this.dateTo&&(t.to=this.dateTo),N.getStatsByDay(t)},getNextPageParam:()=>{},initialPageParam:0,transform:({pages:t}={pageParams:[],pages:[]})=>{const a=t.flatMap(p=>p.items),o=t[t.length-1];return{allItems:a,total:o?.total}},onError:t=>{s.notify.toastError(t)},staleTime:1e3*60,placeholderData:t=>t})}get queryKey(){return["webmaster","stats","daily",this.dateFrom,this.dateTo]}setDateRange(s,t){this.dateFrom=s,this.dateTo=t,this.offset=0,this.query.updateOptions({queryKey:this.queryKey})}handlePagination(s,t){this.offset=(s-1)*t,this.limit=t}refresh(){this.query.refetch()}get allItems(){return this.query.data.allItems}get items(){return this.allItems.slice(this.offset,this.offset+this.limit)}get totalItems(){return this.allItems.length}get currentPage(){return Math.floor(this.offset/this.limit)+1}get total(){return this.query.data.total}}var ft=Object.defineProperty,xt=(i,s,t)=>s in i?ft(i,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[s]=t,_=(i,s,t)=>xt(i,typeof s!="symbol"?s+"":s,t);class gt{constructor(s){_(this,"dailyStatsList"),_(this,"conversionsList"),_(this,"tab","daily"),C(this,{},{autoBind:!0}),this.dailyStatsList=new yt(s),this.conversionsList=new ct(s)}setTab(s){this.tab=s}get activeList(){return this.tab==="conversions"?this.conversionsList:this.dailyStatsList}dispose(){}init(){}}const vt="_container_1pisw_1",bt="_statsCard_1pisw_5",jt="_card_1pisw_9",St="_body_1pisw_13",wt="_table_1pisw_17",It="_pagination_1pisw_28",Dt="_secondary_1pisw_52",h={container:vt,statsCard:bt,card:jt,body:St,table:wt,pagination:It,secondary:Dt},_t={[m.Approved]:"green",[m.Pending]:"orange",[m.Rejected]:"red",[m.Trash]:"default"},Ct=L(function({model:s}){const{t}=A("stats"),[a]=u.useState(()=>Q.set()),o=u.useCallback(n=>{a.has(n)?a.delete(n):a.add(n)},[a]),p=u.useMemo(()=>[{title:t("conversions.table.date"),dataIndex:"createdAt",key:"createdAt",width:72,render:n=>e.jsxs(e.Fragment,{children:[e.jsx(D,{value:n,dateStyle:"short"}),e.jsx("br",{}),e.jsx("span",{className:h.secondary,children:e.jsx(D,{value:n,timeStyle:"short"})})]})},{title:t("conversions.table.status"),dataIndex:["status","type"],key:"status",width:100,render:n=>{const l={[m.Approved]:"conversions.status.approved",[m.Pending]:"conversions.status.pending",[m.Rejected]:"conversions.status.rejected",[m.Trash]:"conversions.status.trash"}[n]||"conversions.status.pending";return e.jsx(st,{color:_t[n],children:t(l)})}},{title:t("conversions.table.offer"),dataIndex:["offer","name"],key:"offer",width:150,ellipsis:!0,render:(n,r)=>e.jsx(q,{to:"/offers/$offerId",params:{offerId:r.offer.id},style:{color:"#1890ff"},children:n})},{title:t("conversions.table.campaign"),key:"campaign",width:150,ellipsis:!0,responsive:["lg"],render:(n,r)=>e.jsx(q,{to:"/campaigns/$campaignId",params:{campaignId:r.campaign.id},style:{color:"#1890ff"},children:r.campaign.name})},{title:t("conversions.table.landing"),dataIndex:["landing","name"],key:"landing",width:100,ellipsis:!0,responsive:["lg"],render:n=>n||t("conversions.table.noData")},{title:t("conversions.table.transit"),dataIndex:["transit","name"],key:"transit",width:100,ellipsis:!0,responsive:["lg"],render:n=>n||t("conversions.table.noData")},{title:t("conversions.table.country"),dataIndex:["geo","country"],key:"country",width:120,responsive:["sm"],render:n=>n?e.jsxs(P,{gap:"xs",align:"center",nowrap:!0,children:[e.jsx(k,{code:n}),e.jsx($,{code:n})]}):t("conversions.table.noData")},{title:t("conversions.table.contacts"),key:"contacts",width:120,ellipsis:!0,responsive:["lg"],render:(n,r)=>{const{name:l,phone:f}=r.client;return!l&&!f?t("conversions.table.noData"):e.jsxs(e.Fragment,{children:[l,e.jsx("br",{}),f]})}},{key:"expand",width:52,render:(n,r)=>e.jsx(G,{children:()=>{const l=a.has(r.id);return e.jsx(E,{type:"text",size:"small",icon:l?e.jsx(W,{}):e.jsx(tt,{}),onClick:()=>o(r.id)})}})}],[a,o,t]),d=J.useBreakpoint(),S=u.useMemo(()=>{let n=950;return d.xs&&(n=500),d.sm&&(n=650),d.md&&(n=800),{x:n}},[d.xs,d.sm,d.md]),j=u.useMemo(()=>H(()=>Array.from(a.values())),[a]).get(),w=u.useMemo(()=>{const n=()=>d.xs?1:d.sm||d.md?2:4;return{showExpandColumn:!1,expandedRowKeys:j,onExpandedRowsChange:r=>{a.replace(r)},expandIcon:()=>null,expandedRowRender:r=>e.jsxs(c,{size:"small",column:n(),bordered:!0,children:[e.jsx(c.Item,{label:t("conversions.table.id"),children:r.id}),e.jsx(c.Item,{label:t("conversions.table.ip"),children:r.technical.ip}),e.jsx(c.Item,{label:t("conversions.table.country"),children:r.geo.country?e.jsxs(P,{gap:"xs",align:"center",nowrap:!0,children:[e.jsx(k,{code:r.geo.country}),e.jsx($,{code:r.geo.country})]}):t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.city"),children:r.geo.city||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.name"),children:r.client.name||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.phone"),children:r.client.phone||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.callsCount"),children:r.client.calls_count}),e.jsx(c.Item,{label:t("conversions.table.firstCalledAt"),children:r.client.firstCalledAt?e.jsx(D,{value:r.client.firstCalledAt,dateStyle:"short",timeStyle:"short"}):t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.gender"),children:r.client.gender||t("conversions.table.noData")}),e.jsx(c.Item,{label:t("conversions.table.age"),children:r.client.age||t("conversions.table.noData")})]})}},[j,d,a,t]),I=u.useMemo(()=>s.conversionsList.query.isFetching?{spinning:!0,tip:t("conversions.loading")}:!1,[s.conversionsList.query.isFetching,t]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:h.table,children:e.jsx(Y,{size:"small",columns:p,dataSource:s.conversionsList.items,loading:I,rowKey:"id",pagination:!1,scroll:S,bordered:!0,expandable:w})}),e.jsxs("div",{className:h.pagination,children:[e.jsxs("div",{style:{marginRight:"auto"},children:[t("conversions.total"),": ",s.conversionsList.total]}),e.jsx(B,{current:s.conversionsList.currentPage,pageSize:s.conversionsList.limit,total:s.conversionsList.total,showSizeChanger:!0,onChange:(n,r)=>s.conversionsList.handlePagination(n,r)})]})]})}),Lt=L(function({model:s}){const{t}=A("stats"),a=u.useMemo(()=>[{title:t("dailyStats.table.date"),dataIndex:"date",key:"date",fixed:"left",render:o=>new Date(o).toLocaleDateString("ru-RU"),width:72},{title:t("dailyStats.table.hits"),dataIndex:["traffic","hits"],key:"hits",width:64},{title:t("dailyStats.table.hosts"),dataIndex:["traffic","hosts"],key:"hosts",width:64},{title:t("dailyStats.table.transitions"),dataIndex:["traffic","transitions"],key:"transitions",width:64},{title:t("dailyStats.table.conversions"),children:[{title:e.jsx(y,{title:t("dailyStats.tooltip.accepted"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(K,{style:{color:"#52c41a",fontSize:"16px"}})})}),dataIndex:["conversions","accepted"],key:"accepted",width:52},{title:e.jsx(y,{title:t("dailyStats.tooltip.pending"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(M,{style:{color:"#faad14",fontSize:"16px"}})})}),dataIndex:["conversions","pending"],key:"pending",width:52},{title:e.jsx(y,{title:t("dailyStats.tooltip.declined"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(F,{style:{color:"#ff4d4f",fontSize:"16px"}})})}),dataIndex:["conversions","declined"],key:"declined",width:52},{title:e.jsx(y,{title:t("dailyStats.tooltip.total"),placement:"top",children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx("span",{style:{fontSize:"16px",fontWeight:"bold"},children:"Σ"})})}),dataIndex:["conversions","total"],key:"total",width:52}]},{title:t("dailyStats.table.coefficients"),children:[{title:t("dailyStats.table.epc"),dataIndex:["coefficients","epc"],key:"epc",width:52,render:o=>`$${o.toFixed(2)}`},{title:t("dailyStats.table.crl"),dataIndex:["coefficients","crl"],key:"crl",width:52,render:o=>`${o.toFixed(2)}%`},{title:t("dailyStats.table.crs"),dataIndex:["coefficients","crs"],key:"crs",width:52,render:o=>`${o.toFixed(2)}%`},{title:t("dailyStats.table.approval"),dataIndex:["coefficients","approval"],key:"approval",width:52,render:o=>`${o.toFixed(2)}%`}]},{title:t("dailyStats.table.revenue"),children:[{title:e.jsx(y,{title:t("dailyStats.tooltip.acceptedRevenue"),placement:"top",overlayStyle:{pointerEvents:"none"},children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(K,{style:{color:"#52c41a",fontSize:"16px"}})})}),dataIndex:["revenue","accepted"],key:"accepted_revenue",width:64,render:o=>`$${o.toFixed(2)}`},{title:e.jsx(y,{title:t("dailyStats.tooltip.pendingRevenue"),placement:"top",overlayStyle:{pointerEvents:"none"},children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(M,{style:{color:"#faad14",fontSize:"16px"}})})}),dataIndex:["revenue","pending"],key:"pending_revenue",width:64,render:o=>`$${o.toFixed(2)}`},{title:e.jsx(y,{title:t("dailyStats.tooltip.declinedRevenue"),placement:"top",overlayStyle:{pointerEvents:"none"},children:e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(F,{style:{color:"#ff4d4f",fontSize:"16px"}})})}),dataIndex:["revenue","declined"],key:"declined_revenue",width:64,render:o=>`$${o.toFixed(2)}`}]}],[t]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:h.table,children:e.jsx(Y,{size:"small",columns:a,dataSource:s.dailyStatsList.items,loading:s.dailyStatsList.query.isFetching?{spinning:!0,tip:t("dailyStats.loading")}:!1,rowKey:"date",pagination:!1,scroll:{x:1500},bordered:!0})}),e.jsxs("div",{className:h.pagination,children:[e.jsxs("div",{style:{marginRight:"auto"},children:[t("dailyStats.totalDays"),": ",s.dailyStatsList.totalItems]}),e.jsx(B,{current:s.dailyStatsList.currentPage,pageSize:s.dailyStatsList.limit,total:s.dailyStatsList.totalItems,showSizeChanger:!0,onChange:(o,p)=>s.dailyStatsList.handlePagination(o,p)})]})]})}),{RangePicker:Tt}=X,Ft=L(function(){const s=U(),{t}=Z("stats"),a=V(()=>new gt(s),[s]),o=a.dailyStatsList.total,p=o?.traffic.hits||0,d=o?.traffic.hosts||0,S=o?.traffic.transitions||0,j=o?.conversions.total||0,w=(o?.revenue.accepted||0)+(o?.revenue.pending||0),I=a.dailyStatsList.dateFrom&&a.dailyStatsList.dateTo?[R(a.dailyStatsList.dateFrom),R(a.dailyStatsList.dateTo)]:null,n=l=>{if(l&&l[0]&&l[1]){const f=l[0].format("YYYY-MM-DD"),T=l[1].format("YYYY-MM-DD");a.dailyStatsList.setDateRange(f,T),a.conversionsList.setDateRange(f,T)}else a.dailyStatsList.setDateRange(void 0,void 0),a.conversionsList.setDateRange(void 0,void 0)},r=l=>{a.setTab(l),l==="conversions"&&a.conversionsList.enableQuery()};return e.jsxs(et,{className:h.container,children:[e.jsx(O,{className:h.card,classNames:{body:h.body},title:e.jsx(at,{tabBarExtraContent:e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(Tt,{value:I,onChange:n,format:"DD.MM.YYYY",placeholder:[t("dateRange.startDate"),t("dateRange.endDate")]}),e.jsx(E,{onClick:a.activeList.refresh,loading:a.activeList.query.isFetching,icon:e.jsx(it,{})})]}),items:[{key:"daily",label:t("tabs.daily")},{key:"conversions",label:t("tabs.conversions")}],activeKey:a.tab,onChange:r}),children:a.tab==="daily"?e.jsx(Lt,{model:a}):e.jsx(Ct,{model:a})}),a.tab==="daily"&&a.dailyStatsList.items.length>0&&e.jsx(O,{className:h.statsCard,size:"small",title:t("summary.title"),children:e.jsxs(nt,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(g,{title:t("summary.hits"),value:p})}),e.jsx(x,{span:6,children:e.jsx(g,{title:t("summary.hosts"),value:d})}),e.jsx(x,{span:6,children:e.jsx(g,{title:t("summary.transitions"),value:S})}),e.jsx(x,{span:6,children:e.jsx(g,{title:t("summary.conversions"),value:j})}),e.jsx(x,{span:6,children:e.jsx(g,{title:t("summary.revenue"),value:w,precision:2,prefix:"$"})})]})})]})}),ae=Ft;export{ae as component};
