import{g as F,r as l,M as I,T as S,w as E,z as q,V as D,x as N,k as M,o as _,j as a,L as y,u as $,q as B}from"./index.B-zO2jcy.js";import{u as x,P as Q}from"./useTranslation.B4Aad4mp.js";import{O as W,B as O}from"./Box.MGoU-yNc.js";import"./AppLayout.4kMJBK_d.js";import{L as z}from"./LayoutContainer.DB_i7kpz.js";import{T as K}from"./Toggler.CKVCiuUU.js";import{C as J}from"./PostbackConfigFormGroup.BbNIFpDK.js";import{R as H}from"./Registry.B8N-PobL.js";import{I as V}from"./InfiniteQueryWithState.BB8vim5Z.js";import{P as T,a as G}from"./PosbackSettings.CnGrxhAS.js";import{r as d,F as U,D as X}from"./renderReactiveCell.HbM7Emo9.js";import{D as h}from"./DateFormat.DYZc4s3P.js";import{T as Y}from"./index.CGcGwI_R.js";import{u as Z}from"./useCopyToClipboard.B86wp29P.js";import{I as ee,T as te}from"./AntdIcon.BzrxpPa1.js";import{B as v}from"./button.BPmN1wK-.js";import{P as ae,R as se}from"./SyncOutlined.BmjTHdYE.js";import{C as ie,T as re}from"./EyeOutlined.DZce5g_D.js";import{D as ne}from"./index.BJBaYR0i.js";import"./index.BmkQiUau.js";import"./validators.CuBSd0d9.js";import"./row.ClGDsWbn.js";import"./SelectControl.BGsAxn8z.js";import"./index.BJKN9cGs.js";import"./index.CspahUgb.js";import"./index.CmXbVTZH.js";import"./index.BcPC7EJu.js";import"./index.BPddU0jj.js";var g={},k;function oe(){if(k)return g;k=1,Object.defineProperty(g,"__esModule",{value:!0});var s={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M456 231a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0z"}}]},name:"more",theme:"outlined"};return g.default=s,g}var ce=oe();const le=F(ce);function j(){return j=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s[i]=t[i])}return s},j.apply(this,arguments)}const me=(s,e)=>l.createElement(ee,j({},s,{ref:e,icon:le})),de=l.forwardRef(me);var pe=Object.defineProperty,ue=(s,e,t)=>e in s?pe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,C=(s,e,t)=>ue(s,typeof e!="symbol"?e+"":e,t);class he{constructor(e,t,i,r={}){this.appContext=e,this.hostnamesQuery=t,this.currentItem=i,this.props=r,C(this,"data"),C(this,"archiveMutation"),C(this,"postbackSettings"),this.data=this.parseData(i),this.postbackSettings=new T(e,this.data.campaign),this.archiveMutation=new I(e.queryClient,{mutationFn:()=>S.deleteCampaignsCampaignid({campaignId:this.campaign.id}),onError:o=>{e.notify.toastError(o)}}),E(this,{data:q.ref,campaign:N})}get id(){return this.campaign.id}get repositories(){return{campaign:this.data.campaignRepository,domains:this.data.domainRepository,hostnames:this.hostnamesQuery.repository}}get hostnames(){return this.hostnamesQuery.items}get campaign(){return this.data.campaign}get archiveState(){return this.archiveMutation}handleArchive(){return this.archiveMutation.mutate()}updateFromJson(e){e!==this.currentItem&&(this.data=this.parseData(e))}parseData(e){const t=this.appContext.repositories.get(D),i=this.appContext.repositories.get(W);return{campaign:t.get(e.id).updateFromJson(e),campaignRepository:t,domainRepository:i}}}var ge=Object.defineProperty,fe=(s,e,t)=>e in s?ge(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,f=(s,e,t)=>fe(s,typeof e!="symbol"?e+"":e,t);class P{constructor(e,t){this.isArchive=t,f(this,"query"),f(this,"hostnamesQuery"),f(this,"limit",20),f(this,"offset",0),this.hostnamesQuery=new J(e);const i=new WeakMap;this.query=new V(e.queryClient,{queryKey:this.getQueryKey(),queryFn:()=>S.getCampaigns({offset:this.offset,limit:this.limit}),getNextPageParam:(r,o)=>{const m=o.reduce((n,c)=>n+c.items.length,0);if(!(m>=r.total))return m},initialPageParam:0,transform:({pages:r}={pageParams:[],pages:[]})=>({data:r.flatMap(m=>{let n=i.get(m);return n||(n=new H(c=>new he(e,this.hostnamesQuery,c))),n.from(m.items)}),total:(r[r.length-1]||{total:0}).total}),staleTime:1e3*60*5,refetchOnWindowFocus:!0,onError:r=>{e.notify.toastError(r)},placeholderData:r=>r}),M(this,{},{autoBind:!0})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}getQueryKey(){return["admin-offers",this.isArchive,this.limit,this.offset]}refresh(){this.query.refetch()}handlePagination(e,t){this.limit=t,this.offset=(e-1)*t,this.query.updateOptions({queryKey:this.getQueryKey()})}}var be=Object.defineProperty,ye=(s,e,t)=>e in s?be(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,p=(s,e,t)=>ye(s,typeof e!="symbol"?e+"":e,t);class ve{constructor(e){p(this,"globalPostback"),p(this,"activeCampaignsList"),p(this,"archiveCampaignsList"),p(this,"tab","active"),p(this,"campaignPostbackToggler",new K(!1)),p(this,"selectedCampaign",null),this.globalPostback=new T(e,null),this.activeCampaignsList=new P(e,!1),this.archiveCampaignsList=new P(e,!0),M(this,{},{autoBind:!0})}setTab(e){this.tab=e}get campaignsList(){return this.tab==="archive"?this.archiveCampaignsList:this.activeCampaignsList}get postbackSettings(){return this.selectedCampaign?this.selectedCampaign.postbackSettings:this.globalPostback}setSelectedCampaign(e){this.selectedCampaign=e}handleOpenCampaignSettings(e){this.selectedCampaign=e,e?.postbackSettings.detailsToggler.enable()}handleAfterOpenChangeCampaignPostback(e){e||this.setSelectedCampaign(null)}dispose(){console.log("dispose")}init(){console.log("init")}}const L=l.createContext(null);function A(){const s=l.useContext(L);if(!s)throw new Error("Необходимо зарегистрировать провайдер WebmasterCampaignsModelContext");return s}var xe=typeof window<"u",Ce=function(s,e){return xe?window.matchMedia(s).matches:!1},je=function(s,e){var t=l.useState(Ce(s)),i=t[0],r=t[1];return l.useEffect(function(){var o=!0,m=window.matchMedia(s),n=function(){o&&r(!!m.matches)};return m.addEventListener("change",n),r(m.matches),function(){o=!1,m.removeEventListener("change",n)}},[s]),i};const _e="_secondary_7t0t2_1",ke="_table_7t0t2_4",Pe="_pagination_7t0t2_13",we="_link_7t0t2_19",Se="_name_7t0t2_27",u={secondary:_e,table:ke,pagination:Pe,link:we,name:Se},Me=l.memo(function({name:e,onConfirm:t}){const i=l.useRef(null),r=l.useRef(!1);return a.jsx(ae,{ref:i,title:`${e}?`,onConfirm:o=>(o?.stopPropagation(),t().then(()=>{r.current=!0,i.current?.popupElement.click()}).catch(()=>{r.current=!1})),onPopupClick:o=>{r.current?r.current=!1:o?.stopPropagation()},onCancel:o=>o?.stopPropagation(),placement:"left",children:a.jsx("div",{onClick:o=>o.stopPropagation(),children:e})})}),w=l.memo(function({value:e}){const[t,i]=l.useState(!1),[r,o]=Z(),{t:m}=x("common"),n=l.useRef(t);return n.current=t,l.useEffect(()=>{if(r.value&&!n.current){i(!0);const c=setTimeout(()=>{i(!1)},1e3);return()=>{clearTimeout(c)}}},[r]),a.jsx(te,{placement:"left",open:t,overlay:m("actions.copied"),children:a.jsx("div",{className:u.link,onClick:c=>{c.preventDefault(),o(e)},children:a.jsx("a",{href:e,target:"__blank",children:e})})})}),Oe=_(function({item:e}){const{t}=x("campaign"),i=A(),r=[{key:"stats",label:a.jsx(y,{to:"/statistics",children:t("actions.stats")})},{key:"edit",label:a.jsx(y,{to:"/campaigns/$campaignId",params:{campaignId:e.id},children:t("actions.edit")})},{key:"postback",label:a.jsx("div",{onClick:()=>{i.handleOpenCampaignSettings(e)},children:t("actions.postback")})},{key:"clone",label:a.jsx(y,{to:"/campaigns/$campaignId",params:{campaignId:"new"},search:{from:e.id,offer:e.campaign.offerId},children:t("actions.clone")})},!e.campaign.isArchived&&{key:"divider",type:"divider"},!e.campaign.isArchived&&{key:"archive",label:a.jsx(Me,{onConfirm:e.handleArchive,name:t("actions.archive")}),danger:!0}].filter(Boolean);return a.jsx(O,{gap:"sm",children:a.jsx(X,{menu:{items:r},trigger:["click"],children:a.jsx(v,{icon:a.jsx(de,{})})})})}),Te=_(function(){const e=A(),{t}=x("campaign"),i=e.campaignsList,r=je("(max-width: 576px)"),o=l.useMemo(()=>[{key:"title",title:t("table.title"),render:d(({campaign:n})=>a.jsx("div",{className:u.name,children:a.jsx(y,{to:"/campaigns/$campaignId",params:{campaignId:n.id},children:n.name})}))},{key:"title",title:t("table.link"),render:d(n=>{const c=n.campaign;return a.jsxs(a.Fragment,{children:[c.transitLink&&a.jsx(w,{value:c.transitLink}),a.jsx(w,{value:c.landingLink})]})})},{key:"source",title:t("table.source"),render:d(n=>{const c=n.campaign,R={"teasers/native":"purple",facebook:"blue","google adwords":"geekblue",seo:"green","news feed":"volcano",other:"default"};return a.jsx(Y,{color:R[c.trafficSource],children:c.trafficSource})}),responsive:["md"]},{key:"createdAt",title:t("table.createdAt"),render:d(({campaign:n})=>a.jsxs(a.Fragment,{children:[a.jsx(h,{value:n.createdAt,dateStyle:"short"}),a.jsx("br",{}),a.jsx("span",{className:u.secondary,children:a.jsx(h,{value:n.createdAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"updatedAt",title:t("table.updatedAt"),render:d(({campaign:n})=>a.jsxs(a.Fragment,{children:[a.jsx(h,{value:n.updatedAt,dateStyle:"short"}),a.jsx("br",{}),a.jsx("span",{className:u.secondary,children:a.jsx(h,{value:n.updatedAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"actions",title:"",render:d(n=>a.jsx(Oe,{item:n}))}].filter(Boolean),[t]);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:u.table,children:a.jsx(U,{rowKey:"id",size:r?"small":"large",loading:!i.query.isFetched&&{size:"large"},columns:o,pagination:!1,dataSource:i.data})}),a.jsx("div",{className:u.pagination,children:a.jsx(Q,{current:i.currentPage,onChange:i.handlePagination,total:i.total,pageSize:i.limit})})]})}),Le="_card_1eces_1",Ae="_body_1eces_1",Re="_head_1eces_6",b={card:Le,body:Ae,head:Re},Fe=_(function(){const e=$(),t=B(()=>new ve(e),[e]),i=t.postbackSettings,{t:r}=x("common");return a.jsx(L.Provider,{value:t,children:a.jsxs(z,{className:b.container,children:[a.jsx(ie,{className:b.card,classNames:{body:b.body,header:b.head},title:a.jsx(re,{tabBarExtraContent:a.jsxs("div",{style:{display:"flex",gap:8},children:[a.jsx(v,{onClick:t.campaignsList.refresh,loading:t.campaignsList.query.isFetching,icon:a.jsx(se,{})}),a.jsx(v,{onClick:t.globalPostback.detailsToggler.enable,children:"Глобальный постбэк"})]}),items:[{key:"active",label:"Активные"},{key:"archive",label:"Архив"}],accessKey:t.tab,onChange:t.setTab}),children:a.jsx(Te,{})}),a.jsx(ne,{size:"large",open:i.detailsToggler.isEnabled,onClose:i.detailsToggler.disable,title:i.title,extra:a.jsx(O,{justify:"space-between",children:a.jsx(v,{type:"primary",onClick:i.createToggler.enable,children:r("buttons.add")})}),children:a.jsx(G,{model:i})})]})})}),lt=()=>a.jsx(Fe,{});export{lt as component};
