import{a0 as w,m as q,e as f,P as h,f as C,t as j,an as c,o as A,r as L,j as r,a4 as T,u as N,a1 as S,l as Q,_ as I}from"./index.WsYO2dy-.js";import{L as E}from"./LayoutContainer.CsWPLRk4.js";import{f as R,c as $,b as B,a as D,O as J,d as K}from"./OfferPayoutRepository.BVytgQiF.js";import{R as M}from"./Registry.HwMJU2b-.js";import{I as k}from"./InfiniteQueryWithState.DXgnPzYl.js";import{O as W}from"./OfferDomainRepository.DVHGC7H4.js";import{O as z}from"./OfferCategoryName.D-zVEtOC.js";import{r as u}from"./renderReactiveCell.wysBt9wO.js";import{C as U}from"./CountryName.CtqEwQTt.js";import{D as y}from"./DateFormat.DX8kRgXq.js";import{u as V}from"./useTranslation.D4fSpiLe.js";import{T as g}from"./index.D7q-MwFy.js";import{T as G}from"./AntdIcon.vojNxC2w.js";import{F as H}from"./Table.Dku94qg-.js";import{P as X}from"./index.DGsLj2m-.js";import{C as Y,T as Z}from"./Input.CS61qdQu.js";import{B as ee}from"./button.B3PsbA3S.js";import{R as te}from"./SyncOutlined.BuXhQB6u.js";import"./useTranslation.Bt2PYRL2.js";import"./useClosable.D4JC76of.js";import"./index.DLZ010Vy.js";import"./index.BAyObCzF.js";var re=Object.defineProperty,se=(a,e,t)=>e in a?re(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,O=(a,e,t)=>se(a,typeof e!="symbol"?e+"":e,t);class ae{constructor(e,t,n,i){this.appContext=e,this.categoriesQuery=t,this.currentItem=n,O(this,"mutation"),O(this,"data"),this.data=this.parseData(n),this.mutation=new w(this.appContext.queryClient,{mutationFn:async l=>R.patchOffersId({offerId:n.id,...l}),onSuccess:l=>{this.updateFromJson(l),i.onUpdate(l)}}),q(this,{data:C.ref,offer:f,category:f,locations:f({equals:h.shallow}),basePayouts:f({equals:h.shallow}),personalPayouts:f({equals:h.shallow}),domains:f({equals:h.shallow}),repositories:f({equals:h.shallow})})}get id(){return this.offer.id}parseData({locations:e,basePayouts:t,personalPayouts:n,domains:i,...l}){const s=this.appContext.repositories.get($),d=this.appContext.repositories.get(B),m=this.appContext.repositories.get(D),x=this.appContext.repositories.get(J),_=this.appContext.repositories.get(W);return{offer:s.get(l.id).updateFromJson({...l,locations:e.map(o=>o.id),basePayouts:t.map(o=>o.id),personalPayouts:n.map(o=>o.id),domains:i.map(o=>o.id)}),locations:e.map(o=>d.get(o.id).updateFromJson(o)),basePayouts:t.map(o=>m.get(o.id).updateFromJson(o)),personalPayouts:n.map(o=>x.get(o.id).updateFromJson(o)),domains:i.map(o=>_.get(o.id).updateFromJson(o)),offerRepository:s,locationRepository:d,personalPayoutRepository:x,basePayoutRepository:m,domainRepository:_}}get repositories(){return{offer:this.data.offerRepository,locations:this.data.locationRepository,domains:this.data.domainRepository,personalPayouts:this.data.personalPayoutRepository,basePayouts:this.data.basePayoutRepository,categories:this.categoriesQuery.repository}}updateFromJson(e){e!==this.currentItem&&(this.data=this.parseData(e))}get offer(){return this.data.offer}get category(){return this.categoriesQuery.repository.get(this.offer.categoryId)}get locations(){return this.data.locations}get basePayouts(){return this.data.basePayouts}get personalPayouts(){return this.data.personalPayouts}get domains(){return this.data.domains}}var oe=Object.defineProperty,ie=(a,e,t)=>e in a?oe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,b=(a,e,t)=>ie(a,typeof e!="symbol"?e+"":e,t);class P{constructor(e,t){this.status=t,b(this,"query"),b(this,"categoriesQuery"),b(this,"limit",10),b(this,"offset",0),this.categoriesQuery=new K(e);const n=new WeakMap;this.query=new k(e.queryClient,{queryKey:this.getQueryKey(),queryFn:()=>R.getAdminOffers({status:this.status,offset:0,limit:20}),getNextPageParam:(i,l)=>{const s=l.reduce((d,m)=>d+m.items.length,0);if(!(s>=i.total))return s},initialPageParam:0,transform:({pages:i}={pageParams:[],pages:[]})=>({data:i.flatMap(s=>{let d=n.get(s);return d||(d=new M(m=>new ae(e,this.categoriesQuery,m,{onUpdate:()=>{this.query.invalidate()}}))),d.from(s.items)}),total:(i[i.length-1]||{total:0}).total}),staleTime:1e3*60*5,refetchOnWindowFocus:!0,onError:i=>{e.notify.toastError(i)},placeholderData:i=>i}),j(this,{},{autoBind:!0})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}refresh(){this.query.refetch()}getQueryKey(){return["advertiser-offers",this.status,this.limit,this.offset]}handlePagination(e,t){this.limit=t,this.offset=(e-1)*t,this.query.updateOptions({queryKey:this.getQueryKey()})}}var ne=Object.defineProperty,le=(a,e,t)=>e in a?ne(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,v=(a,e,t)=>le(a,typeof e!="symbol"?e+"":e,t);class de{constructor(e){v(this,"activeList"),v(this,"pausedList"),v(this,"archivedList"),v(this,"tab",c.Active),this.activeList=new P(e,c.Active),this.pausedList=new P(e,c.Paused),this.archivedList=new P(e,c.Archived),j(this,{},{autoBind:!0})}setTab(e){this.tab=e}get offersList(){return this.tab===c.Paused?this.pausedList:this.tab===c.Archived?this.archivedList:this.activeList}dispose(){console.log("dispose")}init(){console.log("init")}}const ue="_card_hbmmy_1",ce="_body_hbmmy_1",fe="_table_hbmmy_4",pe="_pagination_hbmmy_13",me="_tags_hbmmy_19",he="_secondary_hbmmy_25",p={card:ue,body:ce,table:fe,pagination:pe,tags:me,secondary:he},ye=A(function({page:e}){const{t}=V("offer"),n=e.offersList,i=L.useMemo(()=>[{key:"title",title:t("table.title"),render:u(({offer:s})=>r.jsx(T,{to:"/advertiser/offers/$offerId",params:{offerId:s.id},children:s.title}))},{key:"vertical",title:t("table.vertical"),render:u(({offer:s})=>t(`vertical.${s.vertical}`))},{key:"category",title:t("table.category"),render:u(({category:s})=>r.jsx(z,{category:s}))},{key:"tags",title:t("table.tags"),render:u(({offer:s})=>r.jsxs("div",{className:p.tags,children:[s.accessOnRequest&&r.jsx(g,{color:"error",children:t("status.accessOnRequest")}),s.isExclusive&&r.jsx(g,{color:"purple",children:t("status.isExclusive")}),s.isTopOffer&&r.jsx(g,{color:"blue",children:t("status.isTopOffer")}),s.isTest&&r.jsx(g,{color:"warning",children:t("status.isTest")})]}))},{key:"cr",title:t("table.cr"),render:u(({offer:s})=>s.cr)},{key:"approve",title:t("table.approve"),render:u(({offer:s})=>s.approve)},{key:"languages",title:t("table.languages"),render:u(({locations:s})=>r.jsx(G,{overlay:r.jsx(r.Fragment,{children:s.map(d=>r.jsxs(r.Fragment,{children:[r.jsx(U,{code:d.country})," ",r.jsx("br",{})]}))}),children:r.jsx("div",{children:s.length})}))},{key:"createdAt",title:t("table.createdAt"),render:u(({offer:s})=>r.jsxs(r.Fragment,{children:[r.jsx(y,{value:s.createdAt,dateStyle:"short"}),r.jsx("br",{}),r.jsx("span",{className:p.secondary,children:r.jsx(y,{value:s.createdAt,timeStyle:"short"})})]})),responsive:["md"]},{key:"updatedAt",title:t("table.updatedAt"),render:u(({offer:s})=>r.jsxs(r.Fragment,{children:[r.jsx(y,{value:s.updatedAt,dateStyle:"short"}),r.jsx("br",{}),r.jsx("span",{className:p.secondary,children:r.jsx(y,{value:s.updatedAt,timeStyle:"short"})})]})),responsive:["md"]}].filter(Boolean),[t]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:p.table,children:r.jsx(H,{rowKey:"id",loading:!n.query.isFetched&&{size:"large"},columns:i,pagination:!1,dataSource:n.data})}),r.jsx("div",{className:p.pagination,children:r.jsx(X,{current:n.currentPage,onChange:n.handlePagination,total:n.total,pageSize:n.limit})})]})}),F=A(function(){const e=N(),t=S(()=>new de(e),[e]);return r.jsx(E,{children:r.jsx(Y,{className:p.card,classNames:{body:p.body},title:r.jsx(Z,{tabBarExtraContent:r.jsx("div",{style:{display:"flex",gap:8},children:r.jsx(ee,{onClick:t.offersList.refresh,loading:t.offersList.query.isFetching,icon:r.jsx(te,{})})}),items:[{key:c.Active,label:"Активные"},{key:c.Paused,label:"На паузе"},{key:c.Archived,label:"Архив"}],accessKey:t.tab,onChange:t.setTab}),children:r.jsx(ye,{page:t})})})}),ge=Object.freeze(Object.defineProperty({__proto__:null,AdvertiserOffersPage:F},Symbol.toStringTag,{value:"Module"}));Q(()=>I(()=>Promise.resolve().then(()=>ge),void 0).then(a=>({default:a.AdvertiserOffersPage})));const De=F;export{De as component};
