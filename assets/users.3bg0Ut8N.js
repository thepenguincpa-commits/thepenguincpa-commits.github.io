import{S as N,t as q,a0 as R,G as o,k as B,o as M,j as r,r as p,U as c,u as O,a1 as W}from"./index.CJpzWARr.js";import{L as $}from"./LayoutContainer.kUniMi3O.js";import{U as _,u as P}from"./usersApi.CVFrqcan.js";import{I as Q}from"./InfiniteQueryWithState.DU3fxF3Q.js";import{T as z}from"./Toggler.Bo1KxCe6.js";import{c as y,r as v,e as D,m as k,n as T,V as K,a as V,b as h}from"./validators.puhu6pph.js";import{S as J}from"./SelectControl.BdHLXDxG.js";import{u as G}from"./useTranslation.D1-YSIqG.js";import{M as H}from"./index.CnCisG79.js";import{I as w}from"./index.UwxdIMsP.js";import{S as X,P as Y}from"./index.C7EzEdlH.js";import{F as I}from"./index.D5519FJg.js";import{B as f}from"./button.CTAkPJpI.js";import{r as g}from"./renderReactiveCell.D7yC0G9H.js";import{u as E}from"./useTranslation.DVdJGqhZ.js";import{T as Z}from"./AntdIcon.BEv94oZ9.js";import{R as ee,a as te}from"./ClockCircleOutlined.CyJe1gJd.js";import{T as re}from"./index.mfBRClzR.js";import{F as se,D as U}from"./Table.CnZn0sov.js";import{P as ae}from"./index.Dr9pHSB9.js";import{C as ie,T as oe}from"./Input.BJc5rBil.js";import{R as ne}from"./SyncOutlined.DPlxgDWy.js";import"./row.ZVKcDUTg.js";import"./ActionButton.D2hXE_0n.js";import"./index.CvuYUNlW.js";import"./useClosable.Emosx8Km.js";import"./EyeOutlined.C4wc5N2Y.js";import"./index.B7lSVg36.js";import"./index.5jmBMbM4.js";class le extends N{constructor(e){super(e.queryClient,{queryKey:["managers"],queryFn:async()=>P.getUsers({offset:0,limit:1e3,role:"manager"}),transform:(t={items:[],total:0,offset:0,limit:0})=>{const s=e.repositories.get(_);return{items:t.items.map(n=>s.get(n.id).updateFromJson(n)),repository:s}},staleTime:1e3*60*5,refetchOnWindowFocus:!0})}get repository(){return this.data.repository}get items(){return this.data.items}}var me=Object.defineProperty,ue=(a,e,t)=>e in a?me(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,j=(a,e,t)=>ue(a,typeof e!="symbol"?e+"":e,t);class A{constructor(e,t){this.appContext=e,this.role=t,j(this,"query"),j(this,"managersQuery"),j(this,"limit",10),j(this,"offset",0),q(this,{},{autoBind:!0});const s=e.repositories.get(_);this.managersQuery=new le(e),this.query=new Q(e.queryClient,{queryKey:this.getQueryKey(),queryFn:async()=>P.getUsers({offset:0,limit:20,role:t}),getNextPageParam:(n,l)=>{const i=l.reduce((u,m)=>u+m.items.length,0);if(!(i>=n.total))return i},initialPageParam:0,transform:({pages:n}={pageParams:[],pages:[]})=>({data:n.flatMap(i=>i.items.map(u=>({id:u.id,data:s.get(u.id).updateFromJson(u),manager:u.managerId?this.managersQuery.repository.get(u.managerId):void 0,mutation:this.getUpdateMutation(u.id)}))),total:(n[n.length-1]||{total:0}).total}),onError:n=>{e.notify.toastError(n)},placeholderData:n=>n})}get data(){return this.query.data.data}get total(){return this.query.data.total}get currentPage(){return Math.floor(this.offset/this.limit)+1}refresh(){this.query.refetch()}getQueryKey(){return["admin-users",this.role,this.limit,this.offset]}handlePagination(e,t){this.limit=t,this.offset=(e-1)*t,this.query.updateOptions({queryKey:this.getQueryKey()})}getUpdateMutation(e){return new R(this.appContext.queryClient,{mutationFn:async t=>P.patchUsersUserid({userId:e,userAdminUpdate:t}),onSuccess:t=>{this.appContext.repositories.get(_).get(t.id).updateFromJson(t),this.query.invalidate()}})}}var ce=Object.defineProperty,de=(a,e,t)=>e in a?ce(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,d=(a,e,t)=>de(a,typeof e!="symbol"?e+"":e,t);class pe{constructor(e,t){this.appConfig=e,d(this,"mutation"),d(this,"modalToggler",new z(!1)),d(this,"name",new y("",{validators:[v(()=>this.t.forms("required"))]})),d(this,"role",new J(()=>o.Manager,{options:()=>[{value:o.Manager,label:this.t.common("roles.manager")},{value:o.Admin,label:this.t.common("roles.admin")},{value:o.Advertiser,label:this.t.common("roles.advertiser")},{value:o.Webmaster,label:this.t.common("roles.webmaster")}],validators:[v(()=>this.t.forms("required"))]})),d(this,"email",new y("",{validators:[v(()=>this.t.forms("required")),D(()=>this.t.forms("invalidEmail"))]})),d(this,"telegram",new y("@",{validators:[k(6,()=>this.t.forms("invalidTelegram"))],onChangeValue:s=>{s.startsWith("@")||this.telegram.setValue(`@${s}`)}})),d(this,"password",new y("",{validators:[v(()=>this.t.forms("required")),T(),k(6,()=>this.t.forms("minLength",{count:6}))]})),d(this,"repassword",new y("",{validators:[v(()=>this.t.forms("required")),T(),k(6,()=>this.t.forms("minLength",{count:6})),s=>this.password.value!==s.value?[{message:this.t.forms("passwordsDoNotMatch"),type:K.Error}]:[]]})),d(this,"group",new V({name:this.name,role:this.role,email:this.email,telegram:this.telegram,password:this.password,repassword:this.repassword})),q(this,{handleSubmit:B.bound},{autoBind:!0}),this.mutation=new R(e.queryClient,{mutationFn:async s=>P.postUsers({userAdminCreate:s}),onSuccess:s=>{this.modalToggler.disable(),t(s)},onError:s=>{this.appConfig.notify.toastError(s)}})}get t(){return this.appConfig.locale.translations}handleAfterOpenChange(e){e||this.group.reset()}handleSubmit(){if(this.group.isInvalid){this.group.setTouched(!0),this.group.setDirty(!0),this.group.firstErrorControl?.element?.focus();return}const{repassword:e,...t}=this.group.value;this.mutation.mutate(t)}}var he=Object.defineProperty,ge=(a,e,t)=>e in a?he(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,x=(a,e,t)=>ge(a,typeof e!="symbol"?e+"":e,t);class fe{constructor(e){x(this,"webmastersList"),x(this,"managersList"),x(this,"advertisersList"),x(this,"createModal"),x(this,"tab",o.Webmaster),q(this,{},{autoBind:!0}),this.webmastersList=new A(e,"webmaster"),this.managersList=new A(e,"manager"),this.advertisersList=new A(e,"advertiser"),this.createModal=new pe(e,()=>{this.webmastersList.query.invalidate(),this.advertisersList.query.invalidate(),this.managersList.query.invalidate()})}setTab(e){this.tab=e}get usersList(){return this.tab===o.Advertiser?this.advertisersList:this.tab===o.Manager?this.managersList:this.webmastersList}handleAddUser(){this.createModal.modalToggler.enable()}dispose(){console.log("dispose")}init(){console.log("init")}}const be="_card_1k3hr_1",ye="_body_1k3hr_1",ve="_table_1k3hr_4",we="_pagination_1k3hr_13",C={card:be,body:ye,table:ve,pagination:we},xe=M(function({model:e}){const{t}=G("users");return r.jsx(H,{title:t("userForm.createTitle"),destroyOnHidden:!0,open:e.modalToggler.isEnabled,onCancel:e.modalToggler.disable,maskClosable:!1,afterOpenChange:e.handleAfterOpenChange,footer:r.jsxs(I,{gap:"small",justify:"flex-end",children:[r.jsx(f,{onClick:e.modalToggler.disable,children:t("buttons.cancel",{ns:"common"})}),r.jsx(f,{type:"primary",loading:e.mutation.isPending,onClick:e.handleSubmit,disabled:!e.group.isChanged,children:t("buttons.submit",{ns:"common"})})]}),centered:!0,children:r.jsxs(h,{layout:"vertical",onFinish:e.handleSubmit,children:[r.jsx(h.Item,{label:t("userForm.nameLabel"),...e.name.itemProps,children:r.jsx(w,{autoComplete:"name",placeholder:t("userForm.namePlaceholder"),...e.name.inputProps})}),r.jsx(h.Item,{label:t("userForm.roleLabel"),...e.role.itemProps,children:r.jsx(X,{...e.role.inputProps})}),r.jsx(h.Item,{label:t("userForm.emailLabel"),...e.email.itemProps,children:r.jsx(w,{autoComplete:"email",name:"email",placeholder:t("userForm.emailPlaceholder"),...e.email.inputProps})}),r.jsx(h.Item,{label:t("userForm.telegramLabel"),...e.telegram.itemProps,children:r.jsx(w,{autoComplete:"username",placeholder:t("userForm.emailPlaceholder"),...e.telegram.inputProps})}),r.jsx(h.Item,{label:t("userForm.passwordLabel"),...e.password.itemProps,children:r.jsx(w.Password,{autoComplete:"new-password",placeholder:t("userForm.passwordPlaceholder"),...e.password.inputProps})}),r.jsx(h.Item,{label:t("userForm.confirmPasswordLabel"),...e.repassword.itemProps,children:r.jsx(w.Password,{placeholder:t("userForm.confirmPasswordPlaceholder"),autoComplete:"new-password",...e.repassword.inputProps})})]})})}),S=p.memo(function({name:e,onConfirm:t}){const s=p.useRef(null),n=p.useRef(!1);return r.jsx(ae,{ref:s,title:`${e}?`,onConfirm:l=>(l?.stopPropagation(),t().then(()=>{n.current=!0,s.current?.popupElement.click()}).catch(()=>{n.current=!1})),onPopupClick:l=>{n.current?n.current=!1:l?.stopPropagation()},onCancel:l=>l?.stopPropagation(),placement:"left",children:r.jsx("div",{onClick:l=>l.stopPropagation(),children:e})})}),je=M(function({data:e,mutation:t}){const{t:s}=E("users"),n=p.useMemo(()=>({active:s("actions.activate"),blocked:s("actions.block"),frozen:s("actions.freeze"),pending:s("actions.pending"),review:s("actions.review"),rejected:s("actions.reject")}),[s]),l=p.useMemo(()=>({webmaster:s("actions.webmaster"),advertiser:s("actions.advertiser"),manager:s("actions.manager"),admin:s("actions.admin")}),[s]),i=p.useMemo(()=>{const m=b=>{const L=n[b];return r.jsx(S,{onConfirm:()=>t.mutateAsync({status:b}),name:L})};return{items:[{key:c.Active,label:m(c.Active)},{key:c.Review,label:m(c.Review)},{key:c.Rejected,label:m(c.Rejected)},{key:c.Frozen,label:m(c.Frozen)},{key:"divider",type:"divider"},{key:c.Blocked,label:m(c.Blocked),danger:!0}].filter(Boolean)}},[t,n]),u=p.useMemo(()=>{const m=b=>{const L=l[b];return r.jsx(S,{onConfirm:()=>t.mutateAsync({role:b}),name:L})};return{items:[e.role!==o.Admin&&{key:o.Admin,label:m(o.Admin)},e.role!==o.Advertiser&&{key:o.Advertiser,label:m(o.Advertiser)},e.role!==o.Manager&&{key:o.Manager,label:m(o.Manager)},e.role!==o.Webmaster&&{key:o.Webmaster,label:m(o.Webmaster)}].filter(Boolean)}},[l,t,e.role]);return r.jsxs(I,{gap:"small",children:[r.jsx(U,{menu:i,trigger:["click"],children:r.jsx(f,{children:s("actions.status")})}),r.jsx(U,{menu:u,trigger:["click"],children:r.jsx(f,{children:s("actions.role")})})]})}),Pe=M(function({page:e}){const{t}=E("users"),s=e.usersList,n=p.useMemo(()=>[{key:"email",title:t("table.email"),render:g(({data:i})=>r.jsxs(Z,{title:i.emailConfirmed?t("table.emailConfirmed"):t("table.emailNotConfirmed"),children:[i.email," ",i.emailConfirmed?r.jsx(ee,{style:{color:"var(--ant-color-success)"}}):r.jsx(te,{style:{color:"var(--ant-color-warning)"}})]}))},{key:"telegram",title:t("table.telegram"),render:g(({data:i})=>i.telegram)},{key:"name",title:t("table.name"),render:g(({data:i})=>i.name)},{key:"status",title:t("table.status"),render:g(({data:i})=>{const u={active:t("status.active"),blocked:t("status.blocked"),frozen:t("status.frozen"),pending:t("status.pending"),review:t("status.review"),rejected:t("status.rejected")},F={active:"success",blocked:"error",frozen:"warning",pending:"processing",review:"processing",rejected:"error"}[i.status]||"default";return r.jsx(re,{color:F,children:u[i.status]||i.status})})},e.tab!==o.Manager&&{key:"manager",title:t("table.manager"),render:g(({manager:i})=>i?i.name:t("table.managerNone"))},{key:"registeredAt",title:t("table.registeredAt"),render:g(({data:i})=>new Date(i.createdAt).toLocaleDateString()),responsive:["md"]},{key:"actions",title:t("table.actions"),render:g(i=>r.jsx(je,{...i})),fixed:"right"}].filter(Boolean),[e.tab,t]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:C.table,children:r.jsx(se,{rowKey:"id",loading:!s.query.isFetched&&{size:"large"},columns:n,pagination:!1,dataSource:s.data})}),r.jsx("div",{className:C.pagination,children:r.jsx(Y,{current:s.currentPage,onChange:s.handlePagination,total:s.total,pageSize:s.limit})})]})}),Ce=M(function(){const e=O(),t=W(()=>new fe(e),[e]);return r.jsxs($,{children:[r.jsx(xe,{model:t.createModal}),r.jsx(ie,{className:C.card,classNames:{body:C.body},title:r.jsx(oe,{tabBarExtraContent:r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsx(f,{onClick:t.usersList.refresh,loading:t.usersList.query.isFetching,icon:r.jsx(ne,{})}),r.jsx(f,{type:"primary",onClick:t.handleAddUser,children:"Добавить пользователя"})]}),items:[{key:o.Webmaster,label:"Вебмастеры"},{key:o.Advertiser,label:"Рекламодатели"},{key:o.Manager,label:"Менеджеры"}],accessKey:t.tab,onChange:t.setTab}),children:r.jsx(Pe,{page:t})})]})}),et=Ce;export{et as component};
